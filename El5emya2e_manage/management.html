<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø£Ø³ØªØ§Ø° Ø§Ù„Ø®ÙŠÙ…ÙŠØ§Ø¦ÙŠ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f7f9fb; }
        .container { max-width: 90rem; }
        .header-gradient { background-image: linear-gradient(to right, #4c51bf, #6b46c1); }
    </style>
</head>

<body class="p-4 sm:p-8">

    <header class="header-gradient text-white p-6 rounded-xl shadow-2xl mb-10 container mx-auto">
        <h1 class="text-3xl sm:text-4xl font-extrabold">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬</h1>
        <p class="text-lg mt-2 opacity-90">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ù…Ø³ØªØ± Ù…Ø¤Ù…Ù† - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</p>
    </header>

    <main class="container mx-auto">
        <div class="mb-6 border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px" id="tabs">
                <li class="mr-2">
                    <a href="index.html" class="inline-block p-4 border-b-2 border-transparent rounded-t-lg font-bold text-gray-500 hover:text-indigo-600 hover:border-indigo-400 transition">
                        Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª
                    </a>
                </li>
                <li class="mr-2">
                    <a href="management.html" class="inline-block p-4 border-b-2 border-indigo-600 rounded-t-lg font-bold text-indigo-600 hover:text-indigo-700 hover:border-indigo-400 transition">
                        Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª
                    </a>
                </li>
                <li class="mr-2">
                    <a href="students.html" class="inline-block p-4 border-b-2 border-transparent rounded-t-lg font-bold text-gray-500 hover:text-indigo-600 hover:border-indigo-400 transition">
                        Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ğŸ§‘â€ğŸ“
                    </a>
                </li>
                <li class="mr-2">
                    <a href="ranking.html" class="inline-block p-4 border-b-2 border-transparent rounded-t-lg font-bold text-gray-500 hover:text-indigo-600 hover:border-indigo-400 transition">
                        ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø§Ø¨ ğŸ†
                    </a>
                </li>
            </ul>
        </div>

        <div id="management-content">
            <div id="quizListSection">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h2>
                    <button id="showNewQuizFormBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition">
                        + Ø¥Ø¶Ø§ÙØ© Ø§Ù…ØªØ­Ø§Ù† Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>

                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-100 mb-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-700">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">#</th>
                                    <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">Ø§Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</th>
                                    <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">Ø§Ù„ØµÙ</th>
                                    <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</th>
                                    <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                                </tr>
                            </thead>
                            <tbody id="quizListTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="manageQuizDetailsSection" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†: <span id="editingQuizName" class="text-indigo-600"></span></h2>
                    <div class="flex space-x-2 space-x-reverse">
                        <button onclick="openAddQuestionModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition">
                            + Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯
                        </button>
                        <button onclick="closeEditMode()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition">
                            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
                        </button>
                    </div>
                </div>
                <div id="quizQuestionsContainer" class="space-y-4">
                    <div class="text-center text-gray-500 py-10">... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ...</div>
                </div>
            </div>

            <div id="newQuizSection" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-red-200 border-l-4 hidden">
                <h3 class="text-xl font-bold mb-6 text-gray-800">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù…ØªØ­Ø§Ù† Ø¬Ø¯ÙŠØ¯</h3>
                <form id="newQuizForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="newQuizName" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</label>
                            <input type="text" id="newQuizName" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="newQuizClass" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
                            <select id="newQuizClass" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>
                                <option value="g1">Ø£ÙˆÙ„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                                <option value="g2">ØªØ§Ù†ÙŠØ© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                                <option value="g3">ØªØ§Ù„ØªØ© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                                <option value="s1">Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ</option>
                                <option value="s2">ØªØ§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ</option>
                                <option value="s3">ØªØ§Ù„ØªØ© Ø«Ø§Ù†ÙˆÙŠ</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" id="startAddingQuestionsBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-md transition">
                        Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙˆØ§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                    </button>
                </form>
            </div>

            <div id="questionAdditionSection" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-green-200 border-l-4 mt-6 hidden">
                <h3 class="text-xl font-bold mb-6 text-gray-800">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ <span id="currentQuestionNumber">1</span> Ø¥Ù„Ù‰ Ø§Ù…ØªØ­Ø§Ù†: <span id="currentQuizName" class="text-indigo-600"></span></h3>
                <form id="newQuestionForm" class="space-y-4">
                    <input type="hidden" id="currentQuizId">
                    <div>
                        <label for="questionText" class="block text-sm font-medium text-gray-700 mb-2">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                        <textarea id="questionText" rows="3" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="choiceA" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø£</label>
                            <input type="text" id="choiceA" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="choiceB" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¨</label>
                            <input type="text" id="choiceB" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="choiceC" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¬</label>
                            <input type="text" id="choiceC" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="choiceD" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¯</label>
                            <input type="text" id="choiceD" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="correctAnswer" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</label>
                            <select id="correctAnswer" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© --</option>
                                <option value="A">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø£</option>
                                <option value="B">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¨</option>
                                <option value="C">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¬</option>
                                <option value="D">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¯</option>
                            </select>
                        </div>
                        <div>
                            <label for="explanation" class="block text-sm font-medium text-gray-700 mb-2">Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <input type="text" id="explanation" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-md transition">
                        Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
                    </button>
                    <button type="button" id="finishQuizBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg shadow-md transition">
                        Ø¥Ù†Ù‡Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©)
                    </button>
                </form>
            </div>
        </div>

        <div id="questionEditModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 shadow-lg rounded-md bg-white">
                <h3 class="text-xl font-bold mb-4 text-gray-800" id="questionEditModalTitle">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„</h3>
                <form id="singleQuestionForm" class="space-y-4">
                    <input type="hidden" id="editQuestionId">
                    <input type="hidden" id="editQuestionQuizId">
                    <div>
                        <label for="editQuestionText" class="block text-sm font-medium text-gray-700 mb-2">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                        <textarea id="editQuestionText" rows="3" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editChoiceA" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø£</label>
                            <input type="text" id="editChoiceA" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="editChoiceB" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¨</label>
                            <input type="text" id="editChoiceB" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="editChoiceC" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¬</label>
                            <input type="text" id="editChoiceC" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="editChoiceD" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¯</label>
                            <input type="text" id="editChoiceD" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editCorrectAnswer" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</label>
                            <select id="editCorrectAnswer" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="A">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø£</option>
                                <option value="B">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¨</option>
                                <option value="C">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¬</option>
                                <option value="D">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¯</option>
                            </select>
                        </div>
                        <div>
                            <label for="editExplanation" class="block text-sm font-medium text-gray-700 mb-2">Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <input type="text" id="editExplanation" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 space-x-reverse pt-4">
                        <button type="submit" id="saveQuestionBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition">Ø­ÙØ¸</button>
                        <button type="button" onclick="document.getElementById('questionEditModal').classList.add('hidden')" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        // Configuration
        const SUPABASE_URL = "https://arbbxmnjviryxkmhwdgk.supabase.co";
        const SUPABASE_SERVICE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyYmJ4bW5qdmlyeXhrbWh3ZGdrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MjY5NTU0MSwiZXhwIjoyMDc4MjcxNTQxfQ.W5_c_-VqSUhvHmApF_Y4usZfuCwXz0Ci1hxgfO0u8sc";
        const TABLE_QUIZZES = "alchemiya_quizzes";
        const TABLE_QUESTIONS = "alchemiya_questions";
        
        const classNamesMap = {
            'g1': 'Ø£ÙˆÙ„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ', 'g2': 'ØªØ§Ù†ÙŠØ© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ', 'g3': 'ØªØ§Ù„ØªØ© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ',
            's1': 'Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ', 's2': 'ØªØ§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ', 's3': 'ØªØ§Ù„ØªØ© Ø«Ø§Ù†ÙˆÙŠ'
        };

        let currentEditingQuizId = null;
        let quizzes = [];

        async function supabaseFetch(method, table, query = '', data = null) {
            const url = `${SUPABASE_URL}/rest/v1/${table}${query}`;
            const headers = {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_SERVICE_KEY,
                'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`
            };
            if (method === 'POST' || method === 'PATCH') {
                headers['Prefer'] = 'return=representation';
            }
            const response = await fetch(url, { method, headers, body: data ? JSON.stringify(data) : null });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Supabase Error (${response.status}): ${response.statusText}`);
            }
            if (method === 'DELETE') return { success: true };
            return response.json();
        }

        async function fetchQuizzes() {
            const quizListTableBody = document.getElementById('quizListTableBody');
            quizListTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ...</td></tr>';
            try {
                const url = `${SUPABASE_URL}/rest/v1/${TABLE_QUIZZES}?select=id,quiz_name,class_name,is_active,created_at,${TABLE_QUESTIONS}(count)&order=created_at.desc`;
                const response = await fetch(url, { method: 'GET', headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_SERVICE_KEY, 'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}` } });
                if (!response.ok) throw new Error(response.statusText);
                quizzes = await response.json();
                displayQuizzes(quizzes);
            } catch (error) {
                quizListTableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500 font-bold">Ø®Ø·Ø£: ${error.message}</div></td></tr>`;
            }
        }

        function displayQuizzes(currentQuizzes) {
            const quizListTableBody = document.getElementById('quizListTableBody');
            quizListTableBody.innerHTML = '';
            if (currentQuizzes.length === 0) {
                quizListTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</div></td></tr>';
                return;
            }
            currentQuizzes.forEach((quiz, index) => {
                const isActive = quiz.is_active;
                const statusText = isActive ? 'Ù…ÙØ¹Ù„ âœ…' : 'Ù…ØºÙ„Ù‚ ğŸ”’';
                const statusColor = isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const buttonText = isActive ? 'Ø¥ØºÙ„Ø§Ù‚' : 'ØªÙØ¹ÙŠÙ„';
                const buttonColor = isActive ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600';
                const questionCount = (quiz[TABLE_QUESTIONS] && quiz[TABLE_QUESTIONS][0]) ? quiz[TABLE_QUESTIONS][0].count : 0;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';
                row.innerHTML = `
                    <td class="px-4 py-2 text-sm text-gray-500">${index + 1}</td>
                    <td class="px-4 py-2 font-medium text-gray-900">${quiz.quiz_name}</td>
                    <td class="px-4 py-2 text-sm text-indigo-600">${quiz.class_name}</td>
                    <td class="px-4 py-2 text-sm text-gray-700 font-bold">${questionCount}</td>
                    <td class="px-4 py-2 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${statusText}</span></td>
                    <td class="px-4 py-2 text-center whitespace-nowrap space-x-2 space-x-reverse">
                        <button onclick="toggleQuizStatus(${quiz.id}, ${isActive})" class="text-white font-bold py-1 px-3 rounded-md transition ${buttonColor} text-sm">${buttonText}</button>
                        <button onclick="editQuiz(${quiz.id}, '${quiz.quiz_name}')" class="text-white font-bold py-1 px-3 rounded-md transition bg-blue-600 hover:bg-blue-700 text-sm">ØªØ¹Ø¯ÙŠÙ„</button>
                    </td>
                `;
                quizListTableBody.appendChild(row);
            });
        }

        async function toggleQuizStatus(quizId, currentStatus) {
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ØŸ`)) return;
            try {
                await supabaseFetch('PATCH', TABLE_QUIZZES, `?id=eq.${quizId}`, { is_active: !currentStatus });
                alert('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.');
                fetchQuizzes();
            } catch (error) {
                alert(`ÙØ´Ù„ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©: ${error.message}`);
            }
        }

        // Edit and Logic
        async function editQuiz(quizId, quizName) {
            currentEditingQuizId = quizId;
            document.getElementById('quizListSection').classList.add('hidden');
            document.getElementById('manageQuizDetailsSection').classList.remove('hidden');
            document.getElementById('newQuizSection').classList.add('hidden');
            document.getElementById('questionAdditionSection').classList.add('hidden');
            document.getElementById('editingQuizName').textContent = quizName;
            await fetchQuizQuestions(quizId);
        }

        function closeEditMode() {
            document.getElementById('manageQuizDetailsSection').classList.add('hidden');
            document.getElementById('quizListSection').classList.remove('hidden');
            currentEditingQuizId = null;
            fetchQuizzes();
        }

        async function fetchQuizQuestions(quizId) {
            const container = document.getElementById('quizQuestionsContainer');
            container.innerHTML = '<div class="text-center text-gray-500 py-10">... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ...</div>';
            try {
                const questions = await supabaseFetch('GET', TABLE_QUESTIONS, `?quiz_id=eq.${quizId}&order=id.asc`);
                renderQuestionsForEdit(questions);
            } catch (error) {
                container.innerHTML = `<div class="text-center text-red-500 font-bold">Ø®Ø·Ø£: ${error.message}</div>`;
            }
        }

        function renderQuestionsForEdit(questions) {
            const container = document.getElementById('quizQuestionsContainer');
            container.innerHTML = '';
            if (questions.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†.</div>';
                return;
            }
            questions.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-lg shadow-md border border-gray-200 relative";
                const qJson = JSON.stringify(q).replace(/"/g, '&quot;');
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="font-bold text-lg text-gray-800">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${index + 1}</h4>
                        <div class="flex space-x-2 space-x-reverse">
                            <button onclick="openEditQuestionModal(${qJson})" class="text-blue-600 hover:text-blue-800 font-bold text-sm bg-blue-50 px-3 py-1 rounded">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="deleteQuestion(${q.id})" class="text-red-600 hover:text-red-800 font-bold text-sm bg-red-50 px-3 py-1 rounded">Ø­Ø°Ù</button>
                        </div>
                    </div>
                    <p class="mb-4 text-gray-700 whitespace-pre-line">${q.question_text}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                        <div class="${q.correct_answer === 'A' ? 'bg-green-100 border-green-300' : 'bg-gray-50'} p-2 rounded border">Ø£) ${q.choice_a}</div>
                        <div class="${q.correct_answer === 'B' ? 'bg-green-100 border-green-300' : 'bg-gray-50'} p-2 rounded border">Ø¨) ${q.choice_b}</div>
                        <div class="${q.correct_answer === 'C' ? 'bg-green-100 border-green-300' : 'bg-gray-50'} p-2 rounded border">Ø¬) ${q.choice_c}</div>
                        <div class="${q.correct_answer === 'D' ? 'bg-green-100 border-green-300' : 'bg-gray-50'} p-2 rounded border">Ø¯) ${q.choice_d}</div>
                    </div>
                    ${q.explanation ? `<div class="mt-3 text-sm text-gray-500 bg-yellow-50 p-2 rounded">ğŸ’¡ Ø§Ù„Ø´Ø±Ø­: ${q.explanation}</div>` : ''}
                `;
                container.appendChild(card);
            });
        }

        function openAddQuestionModal() {
            document.getElementById('questionEditModalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯';
            document.getElementById('singleQuestionForm').reset();
            document.getElementById('editQuestionId').value = ''; 
            document.getElementById('editQuestionQuizId').value = currentEditingQuizId;
            document.getElementById('questionEditModal').classList.remove('hidden');
        }

        function openEditQuestionModal(question) {
            document.getElementById('questionEditModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„';
            document.getElementById('editQuestionId').value = question.id;
            document.getElementById('editQuestionQuizId').value = question.quiz_id;
            document.getElementById('editQuestionText').value = question.question_text;
            document.getElementById('editChoiceA').value = question.choice_a;
            document.getElementById('editChoiceB').value = question.choice_b;
            document.getElementById('editChoiceC').value = question.choice_c;
            document.getElementById('editChoiceD').value = question.choice_d;
            document.getElementById('editCorrectAnswer').value = question.correct_answer;
            document.getElementById('editExplanation').value = question.explanation || '';
            document.getElementById('questionEditModal').classList.remove('hidden');
        }

        document.getElementById('singleQuestionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveQuestionBtn');
            btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...'; btn.disabled = true;
            const questionId = document.getElementById('editQuestionId').value;
            const quizId = document.getElementById('editQuestionQuizId').value;
            const data = {
                quiz_id: parseInt(quizId),
                question_text: document.getElementById('editQuestionText').value.trim(),
                choice_a: document.getElementById('editChoiceA').value.trim(),
                choice_b: document.getElementById('editChoiceB').value.trim(),
                choice_c: document.getElementById('editChoiceC').value.trim(),
                choice_d: document.getElementById('editChoiceD').value.trim(),
                correct_answer: document.getElementById('editCorrectAnswer').value,
                explanation: document.getElementById('editExplanation').value.trim() || null
            };
            const isEdit = !!questionId;
            const method = isEdit ? 'PATCH' : 'POST';
            const query = isEdit ? `?id=eq.${questionId}` : '';
            try {
                await supabaseFetch(method, TABLE_QUESTIONS, query, data);
                alert(isEdit ? 'ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­');
                document.getElementById('questionEditModal').classList.add('hidden');
                fetchQuizQuestions(currentEditingQuizId);
            } catch (error) { alert(`ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ${error.message}`); }
            finally { btn.textContent = 'Ø­ÙØ¸'; btn.disabled = false; }
        });

        async function deleteQuestion(questionId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ')) return;
            try {
                await supabaseFetch('DELETE', TABLE_QUESTIONS, `?id=eq.${questionId}`);
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­');
                fetchQuizQuestions(currentEditingQuizId);
            } catch (error) { alert(`ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ${error.message}`); }
        }

        // New Quiz Creation Logic
        const showNewQuizFormBtn = document.getElementById('showNewQuizFormBtn');
        const newQuizSection = document.getElementById('newQuizSection');
        const questionAdditionSection = document.getElementById('questionAdditionSection');
        const newQuizForm = document.getElementById('newQuizForm');
        const newQuestionForm = document.getElementById('newQuestionForm');
        const finishQuizBtn = document.getElementById('finishQuizBtn');
        const currentQuizIdInput = document.getElementById('currentQuizId');
        const currentQuizNameSpan = document.getElementById('currentQuizName');
        const currentQuestionNumberSpan = document.getElementById('currentQuestionNumber');
        let currentQuestionCount = 0;

        showNewQuizFormBtn.addEventListener('click', () => {
            newQuizSection.classList.remove('hidden');
            questionAdditionSection.classList.add('hidden');
            document.getElementById('quizListSection').classList.add('hidden');
            document.getElementById('manageQuizDetailsSection').classList.add('hidden');
        });

        newQuizForm.addEventListener('submit', async(e) => {
            e.preventDefault();
            const quizName = document.getElementById('newQuizName').value.trim();
            const classKey = document.getElementById('newQuizClass').value;
            const className = classNamesMap[classKey];
            if (!quizName || !className) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙ ÙˆØ§Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†.'); return; }
            const button = document.getElementById('startAddingQuestionsBtn');
            button.textContent = '... Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†'; button.disabled = true;
            try {
                const createdQuiz = await supabaseFetch('POST', TABLE_QUIZZES, '', { quiz_name: quizName, class_name: className, is_active: false });
                const quizId = createdQuiz[0].id;
                currentQuizIdInput.value = quizId;
                currentQuizNameSpan.textContent = quizName;
                currentQuestionCount = 0;
                currentQuestionNumberSpan.textContent = currentQuestionCount + 1;
                newQuizSection.classList.add('hidden');
                questionAdditionSection.classList.remove('hidden');
                newQuestionForm.reset();
                alert(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù…ØªØ­Ø§Ù† "${quizName}" Ø¨Ù†Ø¬Ø§Ø­!`);
            } catch (error) { alert(`ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†: ${error.message}`); }
            finally { button.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙˆØ§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©'; button.disabled = false; }
        });

        newQuestionForm.addEventListener('submit', async(e) => {
            e.preventDefault();
            const quizId = currentQuizIdInput.value;
            const button = e.submitter;
            button.textContent = '... Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„'; button.disabled = true;
            const questionData = {
                quiz_id: parseInt(quizId),
                question_text: document.getElementById('questionText').value.trim(),
                choice_a: document.getElementById('choiceA').value.trim(),
                choice_b: document.getElementById('choiceB').value.trim(),
                choice_c: document.getElementById('choiceC').value.trim(),
                choice_d: document.getElementById('choiceD').value.trim(),
                correct_answer: document.getElementById('correctAnswer').value,
                explanation: document.getElementById('explanation').value.trim() || null
            };
            try {
                await supabaseFetch('POST', TABLE_QUESTIONS, '', questionData);
                currentQuestionCount++;
                alert(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${currentQuestionCount} Ø¨Ù†Ø¬Ø§Ø­.`);
                newQuestionForm.reset();
                currentQuestionNumberSpan.textContent = currentQuestionCount + 1;
            } catch (error) { alert(`ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„: ${error.message}`); }
            finally { button.textContent = 'Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ'; button.disabled = false; }
        });

        finishQuizBtn.addEventListener('click', () => {
             if (currentQuestionCount === 0 && !confirm("Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø£Ø³Ø¦Ù„Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")) return;
             questionAdditionSection.classList.add('hidden');
             newQuizForm.reset();
             currentQuestionCount = 0;
             document.getElementById('quizListSection').classList.remove('hidden');
             fetchQuizzes();
        });

        // Initialize
        fetchQuizzes();
    </script>
</body>
</html>