<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ - Ù…Ù†ØµØ© Ø§Ù„Ø®ÙŠÙ…ÙŠØ§Ø¦ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f7f9fb;
        }
        
        .grid {
            display: grid;
        }
        
        body {
            background-image: url('bg.png');
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
        }
        
        #videosContainer {
            scrollbar-width: thin;
            scrollbar-color: #4f46e5 #e0e7ff;
        }
        
        #videosContainer::-webkit-scrollbar {
            width: 8px;
        }
        
        #videosContainer::-webkit-scrollbar-track {
            background: #e0e7ff;
            border-radius: 10px;
        }
        
        #videosContainer::-webkit-scrollbar-thumb {
            background-color: #4f46e5;
            border-radius: 10px;
        }
    </style>
</head>

<body class="bg-fixed bg-cover bg-center text-gray-900 min-h-screen p-4">

    <div class="bg-white/90 backdrop-blur-sm shadow-xl rounded-3xl p-6 w-full max-w-lg mx-auto text-center mb-8 animate__animated animate__fadeInDown border-t-4 border-indigo-600">
        <h1 class="text-4xl font-extrabold text-indigo-800 mb-1">
            <span class="text-5xl">ğŸ§ª</span> Ù…Ù†ØµØ© Ø§Ù„Ø®ÙŠÙ…ÙŠØ§Ø¦ÙŠ
        </h1>
        <p class="text-xl font-semibold text-gray-600">
            ğŸ“˜ Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
        </p>
    </div>

    <div class="bg-white shadow-2xl rounded-3xl p-6 w-full max-w-lg mx-auto mb-8 animate__animated animate__fadeInUp">
        <label for="studentCode" class="block mb-3 text-xl font-bold text-gray-700">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
        <input id="studentCode" type="text" placeholder="Ù…Ø«Ø§Ù„: 12345" class="w-full border-2 border-indigo-300 bg-indigo-50 rounded-xl p-3 text-lg focus:ring-4 focus:ring-indigo-500 focus:border-indigo-500 focus:outline-none transition duration-300 mb-4 text-center placeholder-gray-500"
            onkeypress="if(event.key === 'Enter') searchStudent()">

        <label for="monthFilter" class="block mb-3 text-xl font-bold text-gray-700">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±:</label>
        <select id="monthFilter" class="w-full border-2 border-green-300 bg-green-50 rounded-xl p-3 text-lg focus:ring-4 focus:ring-green-500 focus:border-green-500 focus:outline-none transition duration-300 mb-4 text-center">
            <option value="">-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´Ù‡Ø± --</option>
            <option value="ÙŠÙ†Ø§ÙŠØ±">ÙŠÙ†Ø§ÙŠØ±</option>
            <option value="ÙØ¨Ø±Ø§ÙŠØ±">ÙØ¨Ø±Ø§ÙŠØ±</option>
            <option value="Ù…Ø§Ø±Ø³">Ù…Ø§Ø±Ø³</option>
            <option value="Ø£Ø¨Ø±ÙŠÙ„">Ø£Ø¨Ø±ÙŠÙ„</option>
            <option value="Ù…Ø§ÙŠÙˆ">Ù…Ø§ÙŠÙˆ</option>
            <option value="ÙŠÙˆÙ†ÙŠÙˆ">ÙŠÙˆÙ†ÙŠÙˆ</option>
            <option value="ÙŠÙˆÙ„ÙŠÙˆ">ÙŠÙˆÙ„ÙŠÙˆ</option>
            <option value="Ø£ØºØ³Ø·Ø³">Ø£ØºØ³Ø·Ø³</option>
            <option value="Ø³Ø¨ØªÙ…Ø¨Ø±">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
            <option value="Ø£ÙƒØªÙˆØ¨Ø±">Ø£ÙƒØªÙˆØ¨Ø±</option>
            <option value="Ù†ÙˆÙÙ…Ø¨Ø±">Ù†ÙˆÙÙ…Ø¨Ø±</option>
            <option value="Ø¯ÙŠØ³Ù…Ø¨Ø±">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
        </select>

        <button onclick="searchStudent()" class="w-full bg-indigo-600 text-white font-bold text-lg py-3 rounded-xl hover:bg-indigo-700 transition duration-300 transform hover:scale-[1.01] shadow-lg shadow-indigo-300">
            <span class="ml-2">ğŸ”</span> Ø¨Ø­Ø«
        </button>
    </div>

    <div id="studentInfo" class="w-full max-w-4xl bg-white shadow-2xl rounded-3xl p-6 mx-auto mb-8 animate__animated animate__zoomIn"></div>

    <a href="quiz.html" class="bg-white shadow-xl rounded-3xl p-5 w-full max-w-lg mx-auto text-center mt-8 mb-4 hover:bg-indigo-50 transition duration-300 transform hover:translate-y-[-2px] block border-r-8 border-indigo-500">
        <h2 class="text-2xl font-extrabold text-indigo-700">ØµÙØ­Ù‡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h2>
    </a>

    <button onclick="openVideosModal()" class="bg-white shadow-xl rounded-3xl p-5 w-full max-w-lg mx-auto text-center mt-8 mb-4 hover:bg-indigo-50 transition duration-300 transform hover:translate-y-[-2px] block border-r-8 border-indigo-500">
        <h2 class="text-2xl font-extrabold text-indigo-700">ğŸ¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h2>
    </button>

    <button onclick="openContactsModal()" class="bg-white shadow-xl rounded-3xl p-5 w-full max-w-lg mx-auto text-center mt-4 mb-8 hover:bg-green-50 transition duration-300 transform hover:translate-y-[-2px] block border-r-8 border-green-500">
        <h2 class="text-2xl font-extrabold text-green-700">ğŸ“ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ø¯Ø¹Ù…</h2>
    </button>

    <div id="videosModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-2xl shadow-2xl relative animate__animated animate__fadeInDown max-h-[90vh] overflow-hidden border-t-8 border-indigo-600">
            <button onclick="closeVideosModal()" class="absolute top-4 left-4 text-red-600 hover:text-red-800 font-bold text-2xl transition"><span class="inline-block transform hover:rotate-90 duration-300">âœ–</span></button>
            <h2 class="text-3xl font-extrabold text-indigo-800 mb-6 text-center">ğŸ“½ï¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h2>
            <select id="videoClassSelect" class="w-full border-2 border-indigo-300 bg-indigo-50 p-3 rounded-xl mb-4 text-gray-700 focus:ring-2 focus:ring-indigo-400 focus:outline-none transition" onchange="filterVideosByClass()">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</option>
            </select>
            <div id="videosContainer" class="grid gap-4 overflow-y-auto max-h-80 pr-2"></div>
        </div>
    </div>

    <div id="contactsModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-2xl shadow-2xl relative animate__animated animate__fadeInDown border-t-8 border-green-600">
            <button onclick="closeContactsModal()" class="absolute top-4 left-4 text-red-600 hover:text-red-800 font-bold text-2xl transition"><span class="inline-block transform hover:rotate-90 duration-300">âœ–</span></button>
            <h2 class="text-3xl font-extrabold text-green-800 mb-6 text-center">ğŸ“ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„</h2>
            <div id="contactsContainer" class="grid gap-4"></div>
        </div>
    </div>

    <footer>
        <div class="max-w-4xl mx-auto text-center" style="padding: 40px 0; margin-top: 50px;">
            <div style="background: rgba(255, 255, 255, 0.95); color: #111; max-width: 400px; margin: 0 auto; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 1px solid #ddd; padding: 25px;">
                <p style="font-weight: 600; margin-bottom: 15px; font-size: 16px;">ØµÙÙ…Ù‘Ù… Ø¨ÙˆØ§Ø³Ø·Ø© <span style="color: #2563eb; font-weight: 700;">Abdelrahman Tarek</span></p>
                <a href="https://wa.me/201094724932" target="_blank" style="display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(to right, #2563eb, #3b82f6); color: #fff; font-weight: 600; font-size: 14px; padding: 10px 18px; border-radius: 9999px; text-decoration: none; box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: all 0.3s;"
                    onmouseover="this.style.background='linear-gradient(to right,#3b82f6,#60a5fa)'" onmouseout="this.style.background='linear-gradient(to right,#2563eb,#3b82f6)'"><i class="fa-solid fa-envelope"></i> ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</a>
            </div>
        </div>
    </footer>

    <script>
        // *************************************************************
        // ** ğŸš¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase (ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù‡Ù†Ø§) ğŸš¨ **
        // *************************************************************
        const SUPABASE_URL = "https://arbbxmnjviryxkmhwdgk.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyYmJ4bW5qdmlyeXhrbWh3ZGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2OTU1NDEsImV4cCI6MjA3ODI3MTU0MX0.G-MsJtbQ1LlPZO-Vob6nKzdClHmOYu6RFOKi62FKKNk";

        const TABLE_STUDENTS = "alchemiya_students";
        const TABLE_RECORDS = "alchemiya_records";
        const TABLE_GROUPS = "alchemiya_groups";

        const SHEET_VIDEOS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRj2ajSLPIBsAwHwv8qSVX7_5q5I_LATlqKEWkzOIdF_3Em9PmTTWZ8BnXNau0yCNeF1XAx9KX3PLrN/pub?gid=849351073&single=true&output=csv";
        const SHEET_CONTACTS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRj2ajSLPIBsAwHwv8qSVX7_5q5I_LATlqKEWkzOIdF_3Em9PmTTWZ8BnXNau0yCNeF1XAx9KX3PLrN/pub?gid=218257892&single=true&output=csv";

        async function supabaseFetchAnon(table, query = '') {
            const url = `${SUPABASE_URL}/rest/v1/${table}${query}`;
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            });
            if (!response.ok) throw new Error("Connection Error");
            return response.json();
        }

        function safeNumber(val) {
            return (val === "" || val === null || isNaN(parseFloat(val))) ? 0 : parseFloat(val);
        }

        function isEmptyCell(val) {
            return val === null || val === undefined || (typeof val === 'string' && val.trim() === '');
        }

        async function fetchCSV(url) {
            const res = await fetch(url);
            const text = await res.text();
            const rows = text.trim().split("\n").map(r => r.split(","));
            const headers = rows[0].map(h => h.trim());
            return rows.slice(1).map(row => {
                let obj = {};
                headers.forEach((h, i) => obj[h] = row[i] ? row[i].trim() : "");
                return obj;
            });
        }

        async function searchStudent() {
            const code = document.getElementById("studentCode").value.trim();
            const selectedMonth = document.getElementById("monthFilter").value.trim();
            const infoDiv = document.getElementById("studentInfo");

            infoDiv.classList.remove("animate__zoomIn");
            infoDiv.classList.add("animate__pulse");
            infoDiv.innerHTML = `<p class="text-indigo-600 font-bold text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>`;


            if (!code) {
                infoDiv.innerHTML = `<p class="text-red-600 font-bold text-center">âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</p>`;
                return;
            }

            let student;
            try {
                const studentQuery = `?select=id,student_name,group_id,phone_parent,student_code,${TABLE_GROUPS}(group_name,class_name)&student_code=eq.${code}&limit=1`;
                const studentData = await supabaseFetchAnon(TABLE_STUDENTS, studentQuery);

                if (studentData.length === 0) throw new Error("Not Found");
                student = studentData[0];
            } catch (error) {
                infoDiv.innerHTML = `<p class="text-red-600 font-bold text-center">ğŸš« Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØµØ­ÙŠØ­.</p>`;
                return;
            }

            const studentId = student.id;

            // 2. Ø¬Ù„Ø¨ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ø§Ù„Ù†ØªØ§Ø¦Ø¬)
            // ğŸ›‘ [ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„] ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ homework_done Ø¨Ù€ homework_degree
            let records = [];
            try {
                const recordsQuery = `?select=lesson_number,attendance,homework_degree,exam_degree,recitation_degree,comprehensive_exam_degree,lesson_month,lesson_date&student_id=eq.${studentId}&order=lesson_date.desc`;
                records = await supabaseFetchAnon(TABLE_RECORDS, recordsQuery);
            } catch (error) {
                console.error("Failed to fetch records:", error);
            }

            // ØªØµÙÙŠØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
            if (selectedMonth) {
                records = records.filter(r => r.lesson_month === selectedMonth);
            }

            infoDiv.classList.remove("animate__pulse");

            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØµÙÙŠØ©
            if (records.length === 0 && selectedMonth) {
                infoDiv.innerHTML = `<p class="text-yellow-600 font-bold text-center">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø´Ù‡Ø± ${selectedMonth}</p>`;
                return;
            }

            // 3. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ù„ÙŠÙ„Ù‡Ø§ Ù„Ù„Ø¹Ø±Ø¶
            let totalScoreObtained = 0;
            let totalMaxScore = 0;
            let totalAttendance = 0;

            records.forEach(r => {
                const exam = safeNumber(r.exam_degree);
                const recitation = safeNumber(r.recitation_degree);
                const homework = safeNumber(r.homework_degree); // ğŸ†• [ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„] Ø§Ø³ØªÙ„Ø§Ù… Ø¯Ø±Ø¬Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨
                const comprehensive = safeNumber(r.comprehensive_exam_degree);

                // ğŸ†• [ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„] Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ§Ø¬Ø¨ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹
                totalScoreObtained += (exam + recitation + homework + comprehensive);

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø¸Ù…Ù‰ (Max Score) Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø­ØµØ©
                let currentSessionMax = 0;
                if (exam > 0 || exam === 0) currentSessionMax += 10; 
                if (recitation > 0 || recitation === 0) currentSessionMax += 10; 
                if (homework > 0 || homework === 0) currentSessionMax += 10; // ğŸ†• [ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„] Ù†ÙØªØ±Ø¶ Ø£Ù† Ø¯Ø±Ø¬Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨ Ù…Ù† 10

                if (!isEmptyCell(r.comprehensive_exam_degree)) {
                    currentSessionMax += 20;
                }

                totalMaxScore += currentSessionMax;

                if (r.attendance === 'Ø­Ø¶Ø±') totalAttendance += 1;
            });

            const groupInfo = student[TABLE_GROUPS] || {
                group_name: "â€”",
                class_name: "â€”"
            };

            const percent = totalMaxScore > 0 ? ((totalScoreObtained / totalMaxScore) * 100).toFixed(1) : 0;

            const percentClass = percent >= 85 ? "text-green-600 bg-green-100" : percent >= 60 ? "text-yellow-600 bg-yellow-100" : "text-red-600 bg-red-100";

            const recordsHtml = buildRecordsTable(records);

            // ğŸ†• Ø­Ø³Ø§Ø¨ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
            let rankingHtml = '';
            try {
                const groupId = student.group_id;

                // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
                const groupStudentsQuery = `?select=id,student_name&group_id=eq.${groupId}`;
                const groupStudents = await supabaseFetchAnon(TABLE_STUDENTS, groupStudentsQuery);

                if (groupStudents.length > 0) {
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨
                    const studentScores = [];

                    for (const gs of groupStudents) {
                        try {
                            // ğŸ›‘ [ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„] Ø·Ù„Ø¨Ù†Ø§ Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹ homework_degree
                            const gsRecordsQuery = `?select=exam_degree,recitation_degree,homework_degree,comprehensive_exam_degree&student_id=eq.${gs.id}&order=lesson_date.desc`;
                            const gsRecords = await supabaseFetchAnon(TABLE_RECORDS, gsRecordsQuery);

                            let filteredGsRecords = gsRecords;
                            if (selectedMonth) {
                                // ğŸ›‘ [ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„] ÙˆÙ‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹
                                const gsMonthQuery = `?select=exam_degree,recitation_degree,homework_degree,comprehensive_exam_degree,lesson_month&student_id=eq.${gs.id}&lesson_month=eq.${selectedMonth}`;
                                filteredGsRecords = await supabaseFetchAnon(TABLE_RECORDS, gsMonthQuery);
                            }

                            let gsTotalScore = 0;
                            let gsMaxScore = 0;

                            filteredGsRecords.forEach(r => {
                                const exam = safeNumber(r.exam_degree);
                                const recitation = safeNumber(r.recitation_degree);
                                const homework = safeNumber(r.homework_degree); // ğŸ†•
                                const comprehensive = safeNumber(r.comprehensive_exam_degree);
                                
                                gsTotalScore += (exam + recitation + homework + comprehensive);

                                let currentMax = 0;
                                if (exam > 0 || exam === 0) currentMax += 10;
                                if (recitation > 0 || recitation === 0) currentMax += 10;
                                if (homework > 0 || homework === 0) currentMax += 10; // ğŸ†•
                                if (!isEmptyCell(r.comprehensive_exam_degree)) currentMax += 20;

                                gsMaxScore += currentMax;
                            });

                            const gsPercent = gsMaxScore > 0 ? ((gsTotalScore / gsMaxScore) * 100).toFixed(1) : 0;
                            studentScores.push({
                                name: gs.student_name,
                                percent: parseFloat(gsPercent),
                                isCurrentStudent: gs.id === studentId
                            });
                        } catch (error) {
                            console.error('Error calculating score for student:', error);
                        }
                    }

                    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø§Ø¨
                    studentScores.sort((a, b) => b.percent - a.percent);

                    // Ø¥ÙŠØ¬Ø§Ø¯ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
                    const currentStudentRank = studentScores.findIndex(s => s.isCurrentStudent) + 1;
                    const totalStudentsInGroup = studentScores.length;

                    rankingHtml = `
                        <div class="mt-6 bg-gradient-to-r from-blue-50 to-indigo-50 p-5 rounded-xl shadow-lg border-l-4 border-blue-600">
                            <h3 class="text-2xl font-bold text-blue-800 mb-4">ğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-white p-4 rounded-lg shadow text-center">
                                    <p class="text-gray-600 font-semibold mb-1">ØªØ±ØªÙŠØ¨Ùƒ</p>
                                    <p class="text-4xl font-bold text-indigo-600">${currentStudentRank}</p>
                                    <p class="text-sm text-gray-500">Ù…Ù† ${totalStudentsInGroup} Ø·Ø§Ù„Ø¨</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow text-center">
                                    <p class="text-gray-600 font-semibold mb-1">Ù†Ø³Ø¨ØªÙƒ</p>
                                    <p class="${percentClass} text-3xl font-bold px-2 py-1 rounded">${percent}%</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow text-center">
                                    <p class="text-gray-600 font-semibold mb-1">Ø§Ù„ÙØ±Ù‚ Ø¹Ù† Ø§Ù„Ø£ÙˆÙ„</p>
                                    <p class="text-2xl font-bold ${percent >= studentScores[0].percent ? 'text-green-600' : 'text-orange-600'}">
                                        ${Math.abs((studentScores[0].percent - percent).toFixed(1))}%
                                    </p>
                                </div>
                            </div>
                            
                            <details class="bg-white p-3 rounded-lg shadow">
                                <summary class="cursor-pointer font-bold text-indigo-700 hover:text-indigo-900">ğŸ“Š Ø¹Ø±Ø¶ ØªØ±ØªÙŠØ¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</summary>
                                <div class="mt-3 space-y-2">
                                    ${studentScores.map((s, idx) => `
                                        <div class="flex justify-between items-center p-2 ${s.isCurrentStudent ? 'bg-yellow-100 border-l-4 border-yellow-500' : 'bg-gray-50'} rounded">
                                            <span class="font-semibold">${idx + 1}. ${s.name}</span>
                                            <span class="font-bold ${s.percent >= 85 ? 'text-green-600' : s.percent >= 60 ? 'text-yellow-600' : 'text-red-600'}">${s.percent}%</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error calculating rankings:', error);
                rankingHtml = `<p class="text-yellow-600 text-center mt-4">Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨</p>`;
            }

            infoDiv.innerHTML = `
                <h2 class="text-3xl font-extrabold text-indigo-800 mb-4 border-b-2 pb-2 border-indigo-200">âœ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
                <div class="grid grid-cols-2 gap-4 text-lg mb-4">
                    <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span class="text-gray-700 font-semibold">${student.student_name || "â€”"}</span></p>
                    <p><strong>Ø§Ù„ØµÙ:</strong> <span class="text-gray-700 font-semibold">${groupInfo.class_name || "â€”"}</span></p>
                    <p><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</strong> <span class="text-gray-700 font-semibold">${groupInfo.group_name || "â€”"}</span></p>
                    <p><strong>Ø§Ù„ÙƒÙˆØ¯:</strong> <span class="text-indigo-600 font-bold">${student.student_code || student.id}</span></p>
                    
                </div>

                <h3 class="text-2xl font-bold text-gray-700 mt-6 mb-3 border-b pb-1">ğŸ“š Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª</h3>
                <div class="overflow-x-auto shadow-md rounded-xl mb-4">
                    ${recordsHtml}
                </div>
                
                <div class="mt-6 flex flex-col md:flex-row justify-between items-center bg-indigo-50 p-4 rounded-xl shadow-inner gap-4">
                    <p class="font-bold text-lg text-indigo-700">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª: <span class="text-xl text-black">${totalScoreObtained.toFixed(0)}</span> <span class="text-sm text-gray-500">Ù…Ù† ${totalMaxScore.toFixed(0)}</span></p>
                    <p class="font-bold text-lg text-indigo-700">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±: <span class="text-xl text-black">${totalAttendance}</span></p>
                    <p class="font-bold text-lg text-gray-700">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø©: <span class="${percentClass} px-2 py-1 rounded-lg text-xl font-bold">${percent}%</span></p>
                </div>

                ${rankingHtml}
            `;
            infoDiv.classList.add("animate__zoomIn");
        }

        function buildRecordsTable(records) {
            if (records.length === 0) return `<p class="text-gray-500 p-4 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª.</p>`;

            const groupedByMonth = records.reduce((acc, record) => {
                const month = record.lesson_month || 'Ø¹Ø§Ù…';
                if (!acc[month]) acc[month] = [];
                acc[month].push(record);
                return acc;
            }, {});

            let tableHtml = `
                <table class="w-full border-collapse text-center text-sm">
                    <thead class="bg-indigo-700 text-white shadow-lg">
                        <tr>
                            <th class="p-3">Ø§Ù„Ø´Ù‡Ø±</th>
                            <th class="p-3">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th class="p-3">Ø­ØµØ©</th>
                            <th class="p-3">Ø­Ø¶ÙˆØ±</th>
                            <th class="p-3">ÙˆØ§Ø¬Ø¨ (10)</th> <th class="p-3">ØªØ³Ù…ÙŠØ¹ (10)</th>
                            <th class="p-3">Ø§Ù…ØªØ­Ø§Ù† (10)</th>
                            <th class="p-3">Ø´Ø§Ù…Ù„ (20)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let rowCounter = 0;

            for (const month in groupedByMonth) {
                groupedByMonth[month].forEach(record => {
                    const dateDisplay = new Date(record.lesson_date).toLocaleDateString('ar-EG', {
                        day: 'numeric',
                        month: 'numeric'
                    });
                    const attendanceClass = record.attendance === 'Ø­Ø¶Ø±' ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
                    
                    // ğŸ†• [ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„] Ø¹Ø±Ø¶ Ø¯Ø±Ø¬Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
                    const homeworkDisplay = !isEmptyCell(record.homework_degree) ? `<span class="font-bold text-blue-600">${record.homework_degree}</span>` : 'â€”';

                    const recDegree = !isEmptyCell(record.recitation_degree) ? record.recitation_degree : 'â€”';
                    const examDegree = !isEmptyCell(record.exam_degree) ? record.exam_degree : 'â€”';
                    const compDegree = !isEmptyCell(record.comprehensive_exam_degree) ? `<span class="text-purple-700 font-bold">${record.comprehensive_exam_degree}</span>` : 'â€”';

                    rowCounter++;
                    const rowClass = rowCounter % 2 === 0 ? 'bg-gray-50' : 'bg-white';

                    tableHtml += `
                        <tr class="border-b ${rowClass} hover:bg-indigo-50 transition">
                            <td class="p-2 font-semibold">${month}</td>
                            <td class="p-2 text-gray-600">${dateDisplay}</td>
                            <td class="p-2">${record.lesson_number || 'â€”'}</td>
                            <td class="p-2 ${attendanceClass}">${record.attendance}</td>
                            <td class="p-2">${homeworkDisplay}</td>
                            <td class="p-2 font-medium">${recDegree}</td>
                            <td class="p-2 font-medium">${examDegree}</td>
                            <td class="p-2">${compDegree}</td>
                        </tr>
                    `;
                });
            }

            tableHtml += `</tbody></table>`;
            return tableHtml;
        }

        // ... [Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙˆØ§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ…Ø§ Ù‡Ùˆ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±] ...
        
        let videosData = [];
        async function openVideosModal() {
            document.getElementById("videosModal").classList.remove("hidden");
            document.getElementById("videosModal").style.display = "flex";
            if (videosData.length === 0) {
                document.getElementById("videosContainer").innerHTML = `<p class="text-indigo-600 text-center mt-4 font-semibold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>`;
                try {
                    const videos = await fetchCSV(SHEET_VIDEOS);
                    videosData = videos;
                    const uniqueClasses = [...new Set(videos.map(v => v.class ? v.class.trim() : "").filter(c => c !== ""))];
                    let optionsHtml = `<option value="">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</option>`;
                    uniqueClasses.forEach(cls => {
                        optionsHtml += `<option value="${cls}">${cls}</option>`;
                    });
                    document.getElementById("videoClassSelect").innerHTML = optionsHtml;
                    filterVideosByClass();
                } catch (error) {
                    document.getElementById("videosContainer").innerHTML = `<p class="text-red-500 text-center mt-4">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„Ø´ÙŠØª.</p>`;
                }
            } else {
                filterVideosByClass();
            }
        }

        function closeVideosModal() {
            document.getElementById("videosModal").classList.add("hidden");
            document.getElementById("videosModal").style.display = "none";
        }

        function filterVideosByClass() {
            const selected = document.getElementById("videoClassSelect").value;
            const container = document.getElementById("videosContainer");
            const filtered = selected === "" ?
                videosData :
                videosData.filter(v => v.class && v.class.trim() === selected);
            if (filtered.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª.</p>`;
                return;
            }
            container.innerHTML = filtered.map(v => `<div class="bg-indigo-50 shadow p-4 rounded-xl border hover:bg-indigo-100 transition"><p class="font-bold text-indigo-700">${v.title}</p><p class="text-sm text-gray-600 mb-2">${v.note || ""}</p><a href="${v.link}" target="_blank" class="text-blue-600 font-bold">Ù…Ø´Ø§Ù‡Ø¯Ø© ğŸ“º</a></div>`).join("");
        }

        async function openContactsModal() {
            document.getElementById("contactsModal").classList.remove("hidden");
            document.getElementById("contactsModal").style.display = "flex";
            const container = document.getElementById("contactsContainer");
            container.innerHTML = `<p class="text-green-600 text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>`;
            const contacts = await fetchCSV(SHEET_CONTACTS);
            container.innerHTML = contacts.map(c => {
                let link = (c.type === "whatsapp") ? `https://wa.me/${c.number}` : `tel:${c.number}`;
                return `<div class="bg-gray-50 shadow p-4 rounded-xl hover:bg-green-50 transition"><p class="font-bold text-gray-700 mb-1">${c.label}</p><a href="${link}" target="_blank" class="text-green-600 font-bold">${(c.type === "whatsapp") ? 'ÙˆØ§ØªØ³Ø§Ø¨ ğŸ’¬' : 'Ø§ØªØµØ§Ù„ ğŸ“'}</a></div>`;
            }).join("");
        }

        function closeContactsModal() {
            document.getElementById("contactsModal").classList.add("hidden");
            document.getElementById("contactsModal").style.display = "none";
        }

        document.addEventListener('DOMContentLoaded', () => {
        });
    </script>
</body>

</html>


<!--new-->>
