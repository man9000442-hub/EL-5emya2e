<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุฅุฏุงุฑุฉ ูุชุงุฆุฌ ุงูุฃุณุชุงุฐ ุงูุฎูููุงุฆู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f7f9fb;
        }
        
        .container {
            max-width: 90rem;
        }
        
        .header-gradient {
            background-image: linear-gradient(to right, #4c51bf, #6b46c1);
        }
        
        .table-container::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 4px;
        }
        /* ูุทุจุงุนุฉ ุฌุฏูุฏ ุงููุฑูุช */
        
        @media print {
            body * {
                visibility: hidden;
            }
            #cardsToPrint,
            #cardsToPrint * {
                visibility: visible;
            }
            #cardsToPrint {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 10mm;
            }
            .student-card {
                width: 80mm;
                height: 50mm;
                border: 1px solid #333;
                margin: 5mm;
                padding: 5mm;
                display: inline-block;
                box-sizing: border-box;
                page-break-inside: avoid;
                text-align: center;
            }
        }
    </style>
</head>

<body class="p-4 sm:p-8">

    <header class="header-gradient text-white p-6 rounded-xl shadow-2xl mb-10 container mx-auto">
        <h1 class="text-3xl sm:text-4xl font-extrabold">๐ ููุญุฉ ุงูุฅุฏุงุฑุฉ ูุงููุชุงุฆุฌ</h1>
        <p class="text-lg mt-2 opacity-90">ูุฑุญุจูุง ูุณุชุฑ ูุคูู - ููููู ุฅุฏุงุฑุฉ ุงูุงูุชุญุงูุงุช ูุงูุทูุงุจ ูุนุฑุถ ุงููุชุงุฆุฌ ูู ููุง</p>
    </header>

    <main class="container mx-auto">

        <div class="mb-6 border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px" id="tabs" role="tablist">
                <li class="mr-2" role="presentation">
                    <button id="results-tab" class="inline-block p-4 border-b-2 border-transparent rounded-t-lg font-bold text-gray-500 hover:text-indigo-600 hover:border-indigo-400 transition" type="button" role="tab" aria-selected="false" onclick="showTab('results')">
                        ุนุฑุถ ุงููุชุงุฆุฌ
                    </button>
                </li>
                <li class="mr-2" role="presentation">
                    <button id="management-tab" class="inline-block p-4 border-b-2 border-transparent rounded-t-lg font-bold text-gray-500 hover:text-indigo-600 hover:border-indigo-400 transition" type="button" role="tab" aria-selected="false" onclick="showTab('management')">
                        ุฅุฏุงุฑุฉ ุงูุงูุชุญุงูุงุช
                    </button>
                </li>
                <li class="mr-2" role="presentation">
                    <button id="students-tab" class="inline-block p-4 border-b-2 border-indigo-600 rounded-t-lg font-bold text-indigo-600 hover:text-indigo-700 hover:border-indigo-400 transition" type="button" role="tab" aria-selected="true" onclick="showTab('students')">
                        ุฅุฏุงุฑุฉ ุงูุทูุงุจ ูุงููุฌููุนุงุช ๐งโ๐
                    </button>
                </li>
            </ul>
        </div>

        <div id="results-content" class="tab-content hidden">
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-100 mb-8">
                <h2 class="text-xl font-bold mb-5 text-gray-800">ุชุตููุฉ ุงููุชุงุฆุฌ</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="col-span-full md:col-span-1">
                        <label for="classFilter" class="block text-sm font-medium text-gray-700 mb-2">ุงุฎุชุฑ ุงูุตู ุงูุฏุฑุงุณู</label>
                        <select id="classFilter" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                            <option value="all">ุฌููุน ุงูุตููู</option>
                            <option value="g1">ุฃููู ุฅุนุฏุงุฏู</option>
                            <option value="g2">ุชุงููุฉ ุฅุนุฏุงุฏู</option>
                            <option value="g3">ุชุงูุชุฉ ุฅุนุฏุงุฏู</option>
                            <option value="s1">ุฃููู ุซุงููู</option>
                            <option value="s2">ุชุงููุฉ ุซุงููู</option>
                            <option value="s3">ุชุงูุชุฉ ุซุงููู</option>
                        </select>
                    </div>
                    <div class="col-span-full md:col-span-1">
                        <label for="nameSearch" class="block text-sm font-medium text-gray-700 mb-2">ุงูุจุญุซ ุจุงูุงุณู</label>
                        <input type="text" id="nameSearch" placeholder="ุงุณู ุงูุทุงูุจ ูุงููุงู" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div class="col-span-full md:col-span-1">
                        <label for="phoneSearch" class="block text-sm font-medium text-gray-700 mb-2">ุงูุจุญุซ ุจุฑูู ุงููุงุชู</label>
                        <input type="text" id="phoneSearch" placeholder="ุฑูู ุงููุงุชู" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div class="col-span-full md:col-span-1 flex items-end">
                        <button id="applyFilterBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-md">
                            ุชุทุจูู ุงูููุชุฑ
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">ูุงุฆูุฉ ุงููุชุงุฆุฌ (<span id="resultsCount">0</span> ูุชูุฌุฉ)</h2>
                <div class="table-container overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">#</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุงูุงุณู</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุฑูู ุงููุงุชู</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุงูุตู</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุงูุฏุฑุฌุฉ</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุชุงุฑูุฎ ุงูุฅุฑุณุงู</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุฃุฎุทุงุก (ID)</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-6 py-4 text-center text-gray-500" id="loadingRow">... ุฌุงุฑู ุชุญููู ุงููุชุงุฆุฌ ...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="management-content" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">ุฅุฏุงุฑุฉ ุงูุงูุชุญุงูุงุช</h2>
                <button id="showNewQuizFormBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition">
                    + ุฅุถุงูุฉ ุงูุชุญุงู ุฌุฏูุฏ
                </button>
            </div>

            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-100 mb-8">
                <h3 class="text-xl font-bold mb-4 text-gray-700">ุงูุงูุชุญุงูุงุช ุงููุณุฌูุฉ</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">#</th>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุงุณู ุงูุงูุชุญุงู</th>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุงูุตู</th>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุนุฏุฏ ุงูุฃุณุฆูุฉ</th>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุงูุญุงูุฉ</th>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">ุงูุฅุฌุฑุงุก</th>
                            </tr>
                        </thead>
                        <tbody id="quizListTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">... ุฌุงุฑู ุชุญููู ุงูุงูุชุญุงูุงุช ...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="newQuizSection" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-red-200 border-l-4 hidden">
                <h3 class="text-xl font-bold mb-6 text-gray-800">ุฅูุดุงุก ุงูุชุญุงู ุฌุฏูุฏ</h3>
                <form id="newQuizForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="newQuizName" class="block text-sm font-medium text-gray-700 mb-2">ุงุณู ุงูุงูุชุญุงู</label>
                            <input type="text" id="newQuizName" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="newQuizClass" class="block text-sm font-medium text-gray-700 mb-2">ุงูุตู ุงูุฏุฑุงุณู</label>
                            <select id="newQuizClass" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- ุงุฎุชุฑ ุงูุตู --</option>
                                <option value="g1">ุฃููู ุฅุนุฏุงุฏู</option>
                                <option value="g2">ุชุงููุฉ ุฅุนุฏุงุฏู</option>
                                <option value="g3">ุชุงูุชุฉ ุฅุนุฏุงุฏู</option>
                                <option value="s1">ุฃููู ุซุงููู</option>
                                <option value="s2">ุชุงููุฉ ุซุงููู</option>
                                <option value="s3">ุชุงูุชุฉ ุซุงููู</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" id="startAddingQuestionsBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-md transition">
                        ุฅูุดุงุก ุงูุงูุชุญุงู ูุงูุจุฏุก ูู ุฅุถุงูุฉ ุงูุฃุณุฆูุฉ
                    </button>
                </form>
            </div>

            <div id="questionAdditionSection" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-green-200 border-l-4 mt-6 hidden">
                <h3 class="text-xl font-bold mb-6 text-gray-800">ุฅุถุงูุฉ ุงูุณุคุงู <span id="currentQuestionNumber">1</span> ุฅูู ุงูุชุญุงู: <span id="currentQuizName" class="text-indigo-600"></span></h3>
                <form id="newQuestionForm" class="space-y-4">
                    <input type="hidden" id="currentQuizId">

                    <div>
                        <label for="questionText" class="block text-sm font-medium text-gray-700 mb-2">ูุต ุงูุณุคุงู</label>
                        <textarea id="questionText" rows="3" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="choiceA" class="block text-sm font-medium text-gray-700 mb-2">ุงูุงุฎุชูุงุฑ ุฃ</label>
                            <input type="text" id="choiceA" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="choiceB" class="block text-sm font-medium text-gray-700 mb-2">ุงูุงุฎุชูุงุฑ ุจ</label>
                            <input type="text" id="choiceB" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="choiceC" class="block text-sm font-medium text-gray-700 mb-2">ุงูุงุฎุชูุงุฑ ุฌ</label>
                            <input type="text" id="choiceC" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="choiceD" class="block text-sm font-medium text-gray-700 mb-2">ุงูุงุฎุชูุงุฑ ุฏ</label>
                            <input type="text" id="choiceD" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="correctAnswer" class="block text-sm font-medium text-gray-700 mb-2">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ</label>
                            <select id="correctAnswer" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- ุงุฎุชุฑ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ --</option>
                                <option value="A">ุงูุงุฎุชูุงุฑ ุฃ</option>
                                <option value="B">ุงูุงุฎุชูุงุฑ ุจ</option>
                                <option value="C">ุงูุงุฎุชูุงุฑ ุฌ</option>
                                <option value="D">ุงูุงุฎุชูุงุฑ ุฏ</option>
                            </select>
                        </div>
                        <div>
                            <label for="explanation" class="block text-sm font-medium text-gray-700 mb-2">ุดุฑุญ ุงูุฅุฌุงุจุฉ (ุงุฎุชูุงุฑู)</label>
                            <input type="text" id="explanation" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-md transition">
                        ุญูุธ ุงูุณุคุงู ูุงูุงูุชูุงู ููุณุคุงู ุงูุชุงูู
                    </button>
                    <button type="button" id="finishQuizBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg shadow-md transition">
                        ุฅููุงุก ุฅุถุงูุฉ ุงูุฃุณุฆูุฉ (ูุงูุนูุฏุฉ ูููุงุฆูุฉ)
                    </button>
                </form>
            </div>
        </div>

        <div id="students-content" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">ุฅุฏุงุฑุฉ ุงูุทูุงุจ ูุงููุฌููุนุงุช ๐งโ๐</h2>
                <div class="flex space-x-4 space-x-reverse">
                    <button onclick="showGroupForm()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition">
                        + ุฅุถุงูุฉ ูุฌููุนุฉ ุฌุฏูุฏุฉ
                    </button>
                    <button onclick="showStudentForm()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition">
                        + ุฅุถุงูุฉ ุทุงูุจ ุฌุฏูุฏ
                    </button>
                </div>
            </div>

            <div id="groupFormSection" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-indigo-200 border-l-4 mb-8 hidden">
                <h3 class="text-xl font-bold mb-4 text-gray-800">ุฅุถุงูุฉ ูุฌููุนุฉ</h3>
                <form id="newGroupForm" class="space-y-4">
                    <input type="hidden" id="groupIdToEdit">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="groupName" class="block text-sm font-medium text-gray-700 mb-2">ุงุณู ุงููุฌููุนุฉ (ูุซูุงู: ุฃ - ุงูุณุจุช 4ู)</label>
                            <input type="text" id="groupName" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="groupClass" class="block text-sm font-medium text-gray-700 mb-2">ุงูุตู ุงูุฏุฑุงุณู</label>
                            <select id="groupClass" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- ุงุฎุชุฑ ุงูุตู --</option>
                                <option value="ุฃููู ุฅุนุฏุงุฏู">ุฃููู ุฅุนุฏุงุฏู</option>
                                <option value="ุชุงููุฉ ุฅุนุฏุงุฏู">ุชุงููุฉ ุฅุนุฏุงุฏู</option>
                                <option value="ุชุงูุชุฉ ุฅุนุฏุงุฏู">ุชุงูุชุฉ ุฅุนุฏุงุฏู</option>
                                <option value="ุฃููู ุซุงููู">ุฃููู ุซุงููู</option>
                                <option value="ุชุงููุฉ ุซุงููู">ุชุงููุฉ ุซุงููู</option>
                                <option value="ุชุงูุชุฉ ุซุงููู">ุชุงูุชุฉ ุซุงููู</option>
                            </select>
                        </div>
                        <div>
                            <label for="groupDay" class="block text-sm font-medium text-gray-700 mb-2">ููู ุงูุญุตุฉ</label>
                            <select id="groupDay" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- ุงุฎุชุฑ ุงูููู --</option>
                                <option value="ุงูุณุจุช">ุงูุณุจุช</option>
                                <option value="ุงูุฃุญุฏ">ุงูุฃุญุฏ</option>
                                <option value="ุงูุฅุซููู">ุงูุฅุซููู</option>
                                <option value="ุงูุซูุงุซุงุก">ุงูุซูุงุซุงุก</option>
                                <option value="ุงูุฃุฑุจุนุงุก">ุงูุฃุฑุจุนุงุก</option>
                                <option value="ุงูุฎููุณ">ุงูุฎููุณ</option>
                                <option value="ุงูุฌูุนุฉ">ุงูุฌูุนุฉ</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" id="addGroupBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition">
                        ุญูุธ ุงููุฌููุนุฉ
                    </button>
                    <button type="button" onclick="hideGroupForm()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition">
                        ุฅูุบุงุก
                    </button>
                </form>
            </div>

            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-100 mb-8">
                <h3 class="text-xl font-bold mb-4 text-gray-700">ูุงุฆูุฉ ุงููุฌููุนุงุช ุงููุณุฌูุฉ (<span id="groupsCount">0</span>)</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ID</th>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุงุณู ุงููุฌููุนุฉ</th>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุงูุตู</th>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุงูููู</th>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">ุงูุฅุฌุฑุงุก</th>
                            </tr>
                        </thead>
                        <tbody id="groupsTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">... ุฌุงุฑู ุชุญููู ุงููุฌููุนุงุช ...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="studentFormSection" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-green-200 border-l-4 mb-8 hidden">
                <h3 class="text-xl font-bold mb-4 text-gray-800">ุฅุถุงูุฉ / ุชุนุฏูู ุจูุงูุงุช ุทุงูุจ</h3>
                <form id="newStudentForm" class="space-y-4">
                    <input type="hidden" id="studentIdToEdit">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="studentName" class="block text-sm font-medium text-gray-700 mb-2">ุงุณู ุงูุทุงูุจ ูุงููุงู</label>
                            <input type="text" id="studentName" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label for="studentGroup" class="block text-sm font-medium text-gray-700 mb-2">ุงููุฌููุนุฉ</label>
                            <select id="studentGroup" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">-- ุงุฎุชุฑ ุงููุฌููุนุฉ --</option>
                                </select>
                        </div>
                        <div>
                            <label for="studentPhone" class="block text-sm font-medium text-gray-700 mb-2">ุฑูู ุชููููู ุงูุทุงูุจ</label>
                            <input type="text" id="studentPhone" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label for="parentPhone" class="block text-sm font-medium text-gray-700 mb-2">ุฑูู ุชููููู ููู ุงูุฃูุฑ</label>
                            <input type="text" id="parentPhone" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>
                    <button type="submit" id="addStudentBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition">
                        ุญูุธ ุจูุงูุงุช ุงูุทุงูุจ
                    </button>
                    <button type="button" onclick="hideStudentForm()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition">
                        ุฅูุบุงุก
                    </button>
                </form>
            </div>

            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-100 mb-8">
                <h3 class="text-xl font-bold mb-4 text-gray-800">ุชุตููุฉ ูุจุญุซ ุงูุทูุงุจ</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="studentFilterName" class="block text-sm font-medium text-gray-700 mb-2">ุงูุจุญุซ ุจุงูุงุณู</label>
                        <input type="text" id="studentFilterName" placeholder="ุงุณู ุงูุทุงูุจ" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="studentFilterGroup" class="block text-sm font-medium text-gray-700 mb-2">ุงูุชุตููุฉ ุจุงููุฌููุนุฉ</label>
                        <select id="studentFilterGroup" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="all">ุฌููุน ุงููุฌููุนุงุช</option>
                            </select>
                    </div>
                    <div>
                        <label for="studentFilterPhone" class="block text-sm font-medium text-gray-700 mb-2">ุงูุจุญุซ ุจุฑูู ุงููุงุชู</label>
                        <input type="text" id="studentFilterPhone" placeholder="ุฃู ุฑูู ูุงุชู" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex items-end space-x-2 space-x-reverse">
                        <button id="applyStudentFilterBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-md">
                            ุชุทุจูู
                        </button>
                        <button id="exportCardsBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-md">
                            ุงุณุชุฎุฑุงุฌ ูุฑูุช (PDF)
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-100">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">ูุงุฆูุฉ ุงูุทูุงุจ (<span id="studentsCount">0</span> ุทุงูุจ)</h3>
                <div class="table-container overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">
                                    <input type="checkbox" id="selectAllStudents" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                </th>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุงูููุฏ</th>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุงูุงุณู</th>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุงููุฌููุนุฉ</th>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ุงูุตู</th>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ูุงุชู ุงูุทุงูุจ</th>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ูุงุชู ููู ุงูุฃูุฑ</th>
                                <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">ุงูุฅุฌุฑุงุก</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="8" class="px-6 py-4 text-center text-gray-500">... ุฌุงุฑู ุชุญููู ุงูุทูุงุจ ...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="cardsToPrint" class="hidden"></div>
            <div id="recordModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <h3 class="text-xl font-bold mb-4 text-gray-800" id="recordModalTitle">ุฅุถุงูุฉ ุณุฌู ุฃุฏุงุก ููุทุงูุจ: <span id="recordModalStudentName"></span></h3>
                    <form id="recordForm" class="space-y-4">
                        <input type="hidden" id="recordStudentId">
                        <div>
                            <label for="recordDate" class="block text-sm font-medium text-gray-700 mb-2">ุงูุชุงุฑูุฎ</label>
                            <input type="date" id="recordDate" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="recordMonth" class="block text-sm font-medium text-gray-700 mb-2">ุงูุดูุฑ</label>
                            <select id="recordMonth" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- ุงุฎุชุฑ ุงูุดูุฑ --</option>
                                <option value="ููุงูุฑ">ููุงูุฑ</option><option value="ูุจุฑุงูุฑ">ูุจุฑุงูุฑ</option><option value="ูุงุฑุณ">ูุงุฑุณ</option>
                                <option value="ุฃุจุฑูู">ุฃุจุฑูู</option><option value="ูุงูู">ูุงูู</option><option value="ููููู">ููููู</option>
                                <option value="ููููู">ููููู</option><option value="ุฃุบุณุทุณ">ุฃุบุณุทุณ</option><option value="ุณุจุชูุจุฑ">ุณุจุชูุจุฑ</option>
                                <option value="ุฃูุชูุจุฑ">ุฃูุชูุจุฑ</option><option value="ููููุจุฑ">ููููุจุฑ</option><option value="ุฏูุณูุจุฑ">ุฏูุณูุจุฑ</option>
                            </select>
                        </div>
                        <div>
                            <label for="recordLessonNumber" class="block text-sm font-medium text-gray-700 mb-2">ุฑูู ุงูุญุตุฉ ูู ุงูุดูุฑ</label>
                            <input type="number" id="recordLessonNumber" required min="1" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="recordAttendance" class="block text-sm font-medium text-gray-700 mb-2">ุงูุญุงูุฉ</label>
                            <select id="recordAttendance" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="ุญุถุฑ">ุญุถุฑ</option>
                                <option value="ุบุงุจ">ุบุงุจ</option>
                            </select>
                        </div>
                        <div>
                            <label for="recordHomework" class="block text-sm font-medium text-gray-700 mb-2">ุงููุงุฌุจ</label>
                            <select id="recordHomework" required class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="true">ุชู (ุณูู)</option>
                                <option value="false">ูู ูุชู (ูู ูุณูู)</option>
                            </select>
                        </div>
                        <div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="recordRecitationDegree" class="block text-sm font-medium text-gray-700 mb-2">ุฏุฑุฌุฉ ุงูุชุณููุน (/10)</label>
                                    <input type="number" id="recordRecitationDegree" min="0" max="10" placeholder="0-10" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="recordComprehensiveExam" class="block text-sm font-medium text-gray-700 mb-2">ุงูุงูุชุญุงู ุงูุดุงูู ุงูุดูุฑู (/20)</label>
                                    <input type="number" id="recordComprehensiveExam" min="0" max="20" placeholder="ุงุชุฑูู ูุงุฑุบุงู ููุนุงุฏูุฉ" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>
                            <label for="recordExamDegree" class="block text-sm font-medium text-gray-700 mb-2">ุฏุฑุฌุฉ ุงูุงูุชุญุงู</label>
                            <input type="number" id="recordExamDegree" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex justify-end space-x-2 space-x-reverse">
                            <button type="submit" id="saveRecordBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                ุญูุธ ุงูุณุฌู
                            </button>
                            <button type="button" onclick="document.getElementById('recordModal').classList.add('hidden')" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition">
                                ุฅุบูุงู
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="studentRecordsView" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-yellow-200 border-l-4 hidden">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="showTab('students')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">
                        โ ุงูุนูุฏุฉ ููุงุฆูุฉ ุงูุทูุงุจ
                    </button>
                    <button id="addNewRecordBtn" onclick="openAddRecordForm()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">
                        + ุฅุถุงูุฉ ุณุฌู ุฌุฏูุฏ
                    </button>
                </div>
                <h3 class="text-xl font-bold mb-4 text-gray-800">ุณุฌูุงุช ุฃุฏุงุก ุงูุทุงูุจ: <span id="recordsStudentName" class="text-indigo-600"></span></h3>
                <div class="table-container overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-xs font-medium uppercase tracking-wider text-right">ุงูุชุงุฑูุฎ</th>
                                <th class="px-4 py-2 text-xs font-medium uppercase tracking-wider text-right">ุงูุดูุฑ</th>
                                <th class="px-4 py-2 text-xs font-medium uppercase tracking-wider text-right">ุงูุญุตุฉ ุฑูู</th>
                                <th class="px-4 py-2 text-xs font-medium uppercase tracking-wider text-right">ุงูุญุถูุฑ</th>
                                <th class="px-4 py-2 text-xs font-medium uppercase tracking-wider text-right">ุงููุงุฌุจ</th>
                                <th class="px-4 py-2 text-xs font-medium uppercase tracking-wider text-right">ุชุณููุน /10</th>
                                <th class="px-4 py-2 text-xs font-medium uppercase tracking-wider text-right">ุงูุชุญุงู /10</th>
                                <th class="px-4 py-2 text-xs font-medium uppercase tracking-wider text-right">ุดุงูู /20</th>
                                <th class="px-4 py-2 text-xs font-medium uppercase tracking-wider text-center">ุชุนุฏูู</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-6 py-4 text-center text-gray-500">... ูุง ุชูุฌุฏ ุณุฌูุงุช ููุฐุง ุงูุทุงูุจ ...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <script>
        // *************************************************************
        // ** โ๏ธ ูุฌุจ ุงุณุชุจุฏุงู ุงูููู Placeholder ุจููุงุชูุญู ุงูุญููููุฉ โ๏ธ **
        // *************************************************************
        const SUPABASE_URL = "https://arbbxmnjviryxkmhwdgk.supabase.co";
        const SUPABASE_SERVICE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyYmJ4bW5qdmlyeXhrbWh3ZGdrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MjY5NTU0MSwiZXhwIjoyMDc4MjcxNTQxfQ.W5_c_-VqSUhvHmApF_Y4usZfuCwXz0Ci1hxgfO0u8sc"; // ุงูููุชุงุญ ุงูุณุฑู!

        // ๐จ ุฃุณูุงุก ุงูุฌุฏุงูู
        const TABLE_RESULTS = "alchemiya_results";
        const TABLE_QUIZZES = "alchemiya_quizzes";
        const TABLE_QUESTIONS = "alchemiya_questions";
        // ๐ ุงูุฌุฏุงูู ุงูุฌุฏูุฏุฉ
        const TABLE_GROUPS = "alchemiya_groups";
        const TABLE_STUDENTS = "alchemiya_students";
        const TABLE_RECORDS = "alchemiya_records";
        // *************************************************************

        // ุงูุนูุงุตุฑ ุงููุดุชุฑูุฉ
        const classNamesMap = {
            'g1': 'ุฃููู ุฅุนุฏุงุฏู',
            'g2': 'ุชุงููุฉ ุฅุนุฏุงุฏู',
            'g3': 'ุชุงูุชุฉ ุฅุนุฏุงุฏู',
            's1': 'ุฃููู ุซุงููู',
            's2': 'ุชุงููุฉ ุซุงููู',
            's3': 'ุชุงูุชุฉ ุซุงููู',
            'ุฃููู ุฅุนุฏุงุฏู': 'g1',
            'ุชุงููุฉ ุฅุนุฏุงุฏู': 'g2',
            'ุชุงูุชุฉ ุฅุนุฏุงุฏู': 'g3',
            'ุฃููู ุซุงููู': 's1',
            'ุชุงููุฉ ุซุงููู': 's2',
            'ุชุงูุชุฉ ุซุงููู': 's3'
        };
        const monthNames = ['ููุงูุฑ', 'ูุจุฑุงูุฑ', 'ูุงุฑุณ', 'ุฃุจุฑูู', 'ูุงูู', 'ููููู', 'ููููู', 'ุฃุบุณุทุณ', 'ุณุจุชูุจุฑ', 'ุฃูุชูุจุฑ', 'ููููุจุฑ', 'ุฏูุณูุจุฑ'];
        let groups = [];
        let students = [];
        let selectedStudentIds = new Set();
        let currentViewingStudent = {
            id: null,
            name: null
        }; // ๐ ูุชุฎุฒูู ุจูุงูุงุช ุงูุทุงูุจ ุงููุฑุงุฏ ุนุฑุถ ุณุฌูุงุชู


        // -----------------------------------------------------------
        // 0. ูุธููุฉ ูุณุงุนุฏุฉ ููุงุชุตุงู ุจู Supabase
        // -----------------------------------------------------------

        async function supabaseFetch(method, table, query = '', data = null) {
            const url = `${SUPABASE_URL}/rest/v1/${table}${query}`;
            const headers = {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_SERVICE_KEY,
                'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`
            };
            if (method === 'POST' || method === 'PATCH') {
                headers['Prefer'] = 'return=representation';
            }

            const response = await fetch(url, {
                method: method,
                headers: headers,
                body: data ? JSON.stringify(data) : null
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Supabase Error (${response.status}): ${response.statusText}. Details: ${errorText}`);
            }

            // DELETE requests may not return JSON, so handle that case
            if (method === 'DELETE') {
                return {
                    success: true
                };
            }

            return response.json();
        }

        // -----------------------------------------------------------
        // 1. ูุธุงู ุงูุชุจููุจุงุช (Tabs)
        // -----------------------------------------------------------

        window.showTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('#tabs button').forEach(button => {
                button.classList.remove('border-indigo-600', 'text-indigo-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });

            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            document.getElementById(`${tabName}-tab`).classList.add('border-indigo-600', 'text-indigo-600');
            document.getElementById(`${tabName}-tab`).classList.remove('border-transparent', 'text-gray-500');

            // ุฅุฎูุงุก ูู ุงูููุงุฐุฌ ุงููุฑุนูุฉ ูุฅุธูุงุฑ ุงูุฑุฆูุณูุฉ ููุชุจููุจุงุช ุงููุนููุฉ
            document.getElementById('studentRecordsView').classList.add('hidden');
            document.getElementById('groupFormSection').classList.add('hidden');
            document.getElementById('studentFormSection').classList.add('hidden');
            document.getElementById('newQuizSection').classList.add('hidden');
            document.getElementById('questionAdditionSection').classList.add('hidden');


            if (tabName === 'management') {
                fetchQuizzes();
            } else if (tabName === 'students') {
                fetchGroups();
                fetchStudents();
            } else {
                fetchResults();
            }
        }

        // -----------------------------------------------------------
        // 2. ุฅุฏุงุฑุฉ ุงููุชุงุฆุฌ (Results Management) - (ุชู ุชุนุฏูููุง ูุงุณุชุฎุฏุงู ุฏุงูุฉ ุงููุณุงุนุฏุฉ)
        // -----------------------------------------------------------

        // ... (ููุฏ fetchResults ู displayResults ูุธู ููุง ูู ุชูุฑูุจุงู ูุน ุงุณุชุฎุฏุงู ุฏุงูุฉ supabaseFetch) ...

        async function fetchResults() {
            const resultsTableBody = document.getElementById('resultsTableBody');
            const resultsCountSpan = document.getElementById('resultsCount');
            const classFilter = document.getElementById('classFilter');
            const nameSearch = document.getElementById('nameSearch');
            const phoneSearch = document.getElementById('phoneSearch');

            resultsTableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">... ุฌุงุฑู ุชุญููู ุงููุชุงุฆุฌ ...</td></tr>';
            resultsCountSpan.textContent = '0';

            const selectedClass = classFilter.value;
            const searchName = nameSearch.value.trim();
            const searchPhone = phoneSearch.value.trim();

            let query = '?select=*&order=submission_time.desc';

            if (selectedClass !== 'all') {
                const className = classNamesMap[selectedClass];
                query += `&class_name=eq.${className}`;
            }
            if (searchName) {
                query += `&student_name=ilike.*${searchName}*`;
            }
            if (searchPhone) {
                query += `&student_phone=ilike.*${searchPhone}*`;
            }

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_RESULTS}${query}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_SERVICE_KEY,
                        'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`,
                        'Prefer': 'count=exact'
                    }
                });

                if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);

                const totalCount = response.headers.get('content-range').split('/')[1];
                const data = await response.json();

                displayResults(data);
                resultsCountSpan.textContent = totalCount;

            } catch (error) {
                console.error('Error fetching data from Supabase:', error);
                resultsTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-red-500 font-bold">ุญุฏุซ ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช: ${error.message}. ุชุฃูุฏ ูู ุงุณุชุฎุฏุงู ููุชุงุญ ุงูุฎุฏูุฉ (Service Key).</div></td></tr>`;
            }
        }

        function displayResults(results) {
            const resultsTableBody = document.getElementById('resultsTableBody');
            resultsTableBody.innerHTML = '';
            if (results.length === 0) {
                resultsTableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูุทุงุจูุฉ ูุดุฑูุท ุงูุจุญุซ.</div></td></tr>';
                return;
            }

            results.forEach((result, index) => {
                const percentage = ((result.score / result.total_questions) * 100).toFixed(0);
                let scoreColor = percentage >= 80 ? 'text-green-600 font-extrabold' : (percentage >= 50 ? 'text-yellow-600 font-bold' : 'text-red-600');

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${result.student_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${result.student_phone}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-indigo-600">${result.class_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-lg ${scoreColor}">${result.score} / ${result.total_questions} (${percentage}%)</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(result.submission_time).toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' })}</td>
                    <td class="px-6 py-4 text-sm text-red-400 max-w-xs overflow-hidden text-ellipsis">${result.wrong_questions_ids || 'ูุง ููุฌุฏ'}</td>
                `;
                resultsTableBody.appendChild(row);
            });
        }

        document.getElementById('applyFilterBtn').addEventListener('click', fetchResults);
        document.getElementById('nameSearch').addEventListener('input', fetchResults);
        document.getElementById('phoneSearch').addEventListener('input', fetchResults);
        document.getElementById('classFilter').addEventListener('change', fetchResults);


        // -----------------------------------------------------------
        // 3. ุฅุฏุงุฑุฉ ุงูุงูุชุญุงูุงุช (Quizzes Management) - (ุจุฏูู ุชุบููุฑ)
        // -----------------------------------------------------------

        async function fetchQuizzes() {
            const quizListTableBody = document.getElementById('quizListTableBody');
            quizListTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">... ุฌุงุฑู ุชุญููู ุงูุงูุชุญุงูุงุช ...</td></tr>';
            try {
                const url = `${SUPABASE_URL}/rest/v1/${TABLE_QUIZZES}?select=id,quiz_name,class_name,is_active,created_at,${TABLE_QUESTIONS}(count)&order=created_at.desc`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_SERVICE_KEY,
                        'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`
                    }
                });

                if (!response.ok) throw new Error(response.statusText);

                const fetchedQuizzes = await response.json();
                quizzes = fetchedQuizzes;
                displayQuizzes(quizzes);

            } catch (error) {
                console.error('Error fetching quizzes:', error);
                quizListTableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500 font-bold">ุฎุทุฃ ูู ุฌูุจ ูุงุฆูุฉ ุงูุงูุชุญุงูุงุช: ${error.message}. (400 Bad Request)</div></td></tr>`;
            }
        }

        function displayQuizzes(currentQuizzes) {
            const quizListTableBody = document.getElementById('quizListTableBody');
            quizListTableBody.innerHTML = '';

            if (currentQuizzes.length === 0) {
                quizListTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุงูุชุญุงูุงุช ูุณุฌูุฉ.</div></td></tr>';
                return;
            }

            currentQuizzes.forEach((quiz, index) => {
                const isActive = quiz.is_active;
                const statusText = isActive ? 'ููุนู โ' : 'ูุบูู ๐';
                const statusColor = isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const buttonText = isActive ? 'ุฅุบูุงู' : 'ุชูุนูู';
                const buttonColor = isActive ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600';

                // ุงูุชุตุญูุญ ุงูุขูู ูุงููุงุถุญ ูุฎุทุฃ ุงููุญู ุงูุฃุฎูุฑ
                const questionCount = (quiz[TABLE_QUESTIONS] && quiz[TABLE_QUESTIONS][0]) ? quiz[TABLE_QUESTIONS][0].count : 0;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';
                row.innerHTML = `
                    <td class="px-4 py-2 text-sm text-gray-500">${index + 1}</td>
                    <td class="px-4 py-2 font-medium text-gray-900">${quiz.quiz_name}</td>
                    <td class="px-4 py-2 text-sm text-indigo-600">${quiz.class_name}</td>
                    <td class="px-4 py-2 text-sm text-gray-700 font-bold">${questionCount}</td>
                    <td class="px-4 py-2 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${statusText}</span>
                    </td>
                    <td class="px-4 py-2 text-center whitespace-nowrap">
                        <button onclick="toggleQuizStatus(${quiz.id}, ${isActive})" class="text-white font-bold py-1 px-3 rounded-md transition ${buttonColor} text-sm">
                            ${buttonText}
                        </button>
                    </td>
                `;
                quizListTableBody.appendChild(row);
            });
        }

        async function toggleQuizStatus(quizId, currentStatus) {
            if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุชุบููุฑ ุญุงูุฉ ูุฐุง ุงูุงูุชุญุงูุ`)) return;

            try {
                const newStatus = !currentStatus;
                await supabaseFetch('PATCH', TABLE_QUIZZES, `?id=eq.${quizId}`, {
                    is_active: newStatus
                });

                alert(`ุชู ${newStatus ? 'ุชูุนูู' : 'ุฅุบูุงู'} ุงูุงูุชุญุงู ุจูุฌุงุญ.`);
                fetchQuizzes();

            } catch (error) {
                alert(`ูุดู ูู ุชุบููุฑ ุงูุญุงูุฉ: ${error.message}`);
                console.error('Error toggling quiz status:', error);
            }
        }

        const showNewQuizFormBtn = document.getElementById('showNewQuizFormBtn');
        const newQuizSection = document.getElementById('newQuizSection');
        const questionAdditionSection = document.getElementById('questionAdditionSection');
        const newQuizForm = document.getElementById('newQuizForm');
        const newQuestionForm = document.getElementById('newQuestionForm');
        const finishQuizBtn = document.getElementById('finishQuizBtn');
        const currentQuizIdInput = document.getElementById('currentQuizId');
        const currentQuizNameSpan = document.getElementById('currentQuizName');
        const currentQuestionNumberSpan = document.getElementById('currentQuestionNumber');
        let currentQuestionCount = 0;

        showNewQuizFormBtn.addEventListener('click', () => {
            newQuizSection.classList.remove('hidden');
            questionAdditionSection.classList.add('hidden');
        });

        newQuizForm.addEventListener('submit', async(e) => {
            e.preventDefault();
            const quizName = document.getElementById('newQuizName').value.trim();
            const classKey = document.getElementById('newQuizClass').value;
            const className = classNamesMap[classKey];

            if (!quizName || !className) {
                alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงูุตู ูุงุณู ุงูุงูุชุญุงู.');
                return;
            }

            const button = document.getElementById('startAddingQuestionsBtn');
            button.textContent = '... ุฌุงุฑู ุฅูุดุงุก ุงูุงูุชุญุงู';
            button.disabled = true;

            try {
                const createdQuiz = await supabaseFetch('POST', TABLE_QUIZZES, '', {
                    quiz_name: quizName,
                    class_name: className,
                    is_active: false
                });

                const quizId = createdQuiz[0].id;

                currentQuizIdInput.value = quizId;
                currentQuizNameSpan.textContent = quizName;
                currentQuestionCount = 0;
                currentQuestionNumberSpan.textContent = currentQuestionCount + 1;

                newQuizSection.classList.add('hidden');
                questionAdditionSection.classList.remove('hidden');
                newQuestionForm.reset();

                alert(`ุชู ุฅูุดุงุก ุงูุชุญุงู "${quizName}" ุจูุฌุงุญ! ุงุจุฏุฃ ูู ุฅุถุงูุฉ ุงูุฃุณุฆูุฉ.`);

            } catch (error) {
                alert(`ูุดู ุฅูุดุงุก ุงูุงูุชุญุงู: ${error.message}`);
                console.error('Error creating quiz:', error);
            } finally {
                button.textContent = 'ุฅูุดุงุก ุงูุงูุชุญุงู ูุงูุจุฏุก ูู ุฅุถุงูุฉ ุงูุฃุณุฆูุฉ';
                button.disabled = false;
            }
        });

        newQuestionForm.addEventListener('submit', async(e) => {
            e.preventDefault();

            const quizId = currentQuizIdInput.value;
            const button = e.submitter;
            button.textContent = '... ุฌุงุฑู ุญูุธ ุงูุณุคุงู';
            button.disabled = true;

            const questionData = {
                quiz_id: parseInt(quizId),
                question_text: document.getElementById('questionText').value.trim(),
                choice_a: document.getElementById('choiceA').value.trim(),
                choice_b: document.getElementById('choiceB').value.trim(),
                choice_c: document.getElementById('choiceC').value.trim(),
                choice_d: document.getElementById('choiceD').value.trim(),
                correct_answer: document.getElementById('correctAnswer').value,
                explanation: document.getElementById('explanation').value.trim() || null
            };

            if (!questionData.question_text || !questionData.correct_answer || !questionData.choice_a || !questionData.choice_b || !questionData.choice_c || !questionData.choice_d) {
                alert("ุงูุฑุฌุงุก ููุก ุฌููุน ุญููู ุงูุณุคุงู ูุงูุงุฎุชูุงุฑุงุช ูุงุฎุชูุงุฑ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ.");
                button.textContent = 'ุญูุธ ุงูุณุคุงู ูุงูุงูุชูุงู ููุณุคุงู ุงูุชุงูู';
                button.disabled = false;
                return;
            }

            try {
                await supabaseFetch('POST', TABLE_QUESTIONS, '', questionData);

                currentQuestionCount++;
                alert(`ุชู ุญูุธ ุงูุณุคุงู ุฑูู ${currentQuestionCount} ุจูุฌุงุญ.`);

                newQuestionForm.reset();
                currentQuestionNumberSpan.textContent = currentQuestionCount + 1;

            } catch (error) {
                alert(`ูุดู ูู ุญูุธ ุงูุณุคุงู: ${error.message}`);
                console.error('Error adding question:', error);
            } finally {
                button.textContent = 'ุญูุธ ุงูุณุคุงู ูุงูุงูุชูุงู ููุณุคุงู ุงูุชุงูู';
                button.disabled = false;
            }
        });

        finishQuizBtn.addEventListener('click', () => {
            if (currentQuestionCount === 0) {
                if (!confirm("ูู ูุชู ุฅุถุงูุฉ ุฃู ุฃุณุฆูุฉ ููุฐุง ุงูุงูุชุญุงู. ูู ุชุฑูุฏ ุฅููุงุก ุงูุนูููุฉ ูุงูุนูุฏุฉุ")) return;
            } else if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุฅููุงุก ุฅุถุงูุฉ ุงูุฃุณุฆูุฉ ููุงูุชุญุงู (${currentQuestionCount} ุณุคุงูุงู)ุ`)) {
                return;
            }

            questionAdditionSection.classList.add('hidden');
            newQuizForm.reset();
            currentQuestionCount = 0;
            fetchQuizzes();
            alert('ุชู ุฅููุงุก ุนูููุฉ ุฅุถุงูุฉ ุงูุฃุณุฆูุฉ ุจูุฌุงุญ. ููููู ุชูุนูู ุงูุงูุชุญุงู ูู ุงููุงุฆูุฉ.');
        });


        // -----------------------------------------------------------
        // 4. ุฅุฏุงุฑุฉ ุงููุฌููุนุงุช ูุงูุทูุงุจ ูุงูุณุฌูุงุช (Students Management) ๐
        // -----------------------------------------------------------

        const groupsTableBody = document.getElementById('groupsTableBody');
        const groupsCountSpan = document.getElementById('groupsCount');
        const studentsTableBody = document.getElementById('studentsTableBody');
        const studentsCountSpan = document.getElementById('studentsCount');
        const studentGroupSelect = document.getElementById('studentGroup');
        const studentFilterGroupSelect = document.getElementById('studentFilterGroup');
        const studentFilterName = document.getElementById('studentFilterName');
        const studentFilterPhone = document.getElementById('studentFilterPhone');
        const studentFilterGroup = document.getElementById('studentFilterGroup');
        const newGroupForm = document.getElementById('newGroupForm');
        const newStudentForm = document.getElementById('newStudentForm');
        const exportCardsBtn = document.getElementById('exportCardsBtn');
        const selectAllStudents = document.getElementById('selectAllStudents');

        // ---- A. ูุธุงุฆู ุงููุฌููุนุงุช (Groups) ----

        function showGroupForm(group = null) {
            const groupFormSection = document.getElementById('groupFormSection');
            const groupIdToEdit = document.getElementById('groupIdToEdit');
            const groupNameInput = document.getElementById('groupName');
            const groupClassSelect = document.getElementById('groupClass');
            const groupDaySelect = document.getElementById('groupDay');
            const addGroupBtn = document.getElementById('addGroupBtn');

            groupFormSection.classList.remove('hidden');

            if (group) {
                groupIdToEdit.value = group.id;
                groupNameInput.value = group.group_name;
                groupClassSelect.value = group.class_name;
                groupDaySelect.value = group.day_of_week;
                addGroupBtn.textContent = 'ุญูุธ ุงูุชุนุฏููุงุช';
            } else {
                groupIdToEdit.value = '';
                newGroupForm.reset();
                addGroupBtn.textContent = 'ุญูุธ ุงููุฌููุนุฉ';
            }
        }

        function hideGroupForm() {
            document.getElementById('groupFormSection').classList.add('hidden');
        }

        async function fetchGroups() {
            groupsTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">... ุฌุงุฑู ุชุญููู ุงููุฌููุนุงุช ...</td></tr>';
            try {
                groups = await supabaseFetch('GET', TABLE_GROUPS, '?select=*&order=class_name.asc,day_of_week.asc');
                displayGroups(groups);
                populateGroupSelects(groups);
            } catch (error) {
                console.error('Error fetching groups:', error);
                groupsTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500 font-bold">ุฎุทุฃ ูู ุฌูุจ ุงููุฌููุนุงุช: ${error.message}</td></tr>`;
            }
        }

        function displayGroups(currentGroups) {
            groupsTableBody.innerHTML = '';
            groupsCountSpan.textContent = currentGroups.length;
            if (currentGroups.length === 0) {
                groupsTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">ูุง ุชูุฌุฏ ูุฌููุนุงุช ูุณุฌูุฉ.</td></tr>';
                return;
            }

            currentGroups.forEach((group) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';
                row.innerHTML = `
                    <td class="px-4 py-2 text-sm text-gray-500">${group.id}</td>
                    <td class="px-4 py-2 font-medium text-gray-900">${group.group_name}</td>
                    <td class="px-4 py-2 text-sm text-indigo-600">${group.class_name}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${group.day_of_week}</td>
                    <td class="px-4 py-2 text-center whitespace-nowrap">
                        <button onclick="editGroup(${group.id})" class="text-indigo-600 hover:text-indigo-900 font-bold py-1 px-2 rounded-md transition text-sm">ุชุนุฏูู</button>
                    </td>
                `;
                groupsTableBody.appendChild(row);
            });
        }

        function populateGroupSelects(groupsList) {
            studentGroupSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุฌููุนุฉ --</option>';
            studentFilterGroupSelect.innerHTML = '<option value="all">ุฌููุน ุงููุฌููุนุงุช</option>';
            groupsList.forEach(group => {
                const option = `<option value="${group.id}">${group.class_name} - ${group.group_name} (${group.day_of_week})</option>`;
                studentGroupSelect.insertAdjacentHTML('beforeend', option);
                studentFilterGroupSelect.insertAdjacentHTML('beforeend', option);
            });
        }

        async function editGroup(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (group) {
                showGroupForm(group);
            }
        }

        newGroupForm.addEventListener('submit', async(e) => {
            e.preventDefault();
            const groupId = document.getElementById('groupIdToEdit').value;
            const groupName = document.getElementById('groupName').value.trim();
            const groupClass = document.getElementById('groupClass').value;
            const groupDay = document.getElementById('groupDay').value;

            const data = {
                group_name: groupName,
                class_name: groupClass,
                day_of_week: groupDay
            };

            const isEdit = !!groupId;
            const method = isEdit ? 'PATCH' : 'POST';
            const query = isEdit ? `?id=eq.${groupId}` : '';
            const action = isEdit ? 'ุชุนุฏูู' : 'ุฅุถุงูุฉ';

            try {
                await supabaseFetch(method, TABLE_GROUPS, query, data);
                alert(`ุชู ${action} ุงููุฌููุนุฉ ุจูุฌุงุญ.`);
                newGroupForm.reset();
                hideGroupForm();
                fetchGroups();
                fetchStudents();
            } catch (error) {
                alert(`ูุดู ${action} ุงููุฌููุนุฉ: ${error.message}`);
                console.error(`Error ${action} group:`, error);
            }
        });


        // ---- B. ูุธุงุฆู ุงูุทูุงุจ (Students) ----

        function showStudentForm(student = null) {
            const studentFormSection = document.getElementById('studentFormSection');
            const studentIdToEdit = document.getElementById('studentIdToEdit');
            const studentNameInput = document.getElementById('studentName');
            const studentGroupSelect = document.getElementById('studentGroup');
            const studentPhoneInput = document.getElementById('studentPhone');
            const parentPhoneInput = document.getElementById('parentPhone');
            const addStudentBtn = document.getElementById('addStudentBtn');

            studentFormSection.classList.remove('hidden');

            if (student) {
                studentIdToEdit.value = student.id;
                studentNameInput.value = student.student_name;
                studentGroupSelect.value = student.group_id;
                studentPhoneInput.value = student.phone_student || '';
                parentPhoneInput.value = student.phone_parent || '';
                addStudentBtn.textContent = 'ุญูุธ ุชุนุฏููุงุช ุงูุทุงูุจ';
            } else {
                studentIdToEdit.value = '';
                newStudentForm.reset();
                addStudentBtn.textContent = 'ุญูุธ ุจูุงูุงุช ุงูุทุงูุจ';
            }
            // ุฅุนุงุฏุฉ ุชุนุจุฆุฉ ุงููุงุฆูุฉ ุงูููุณุฏูุฉ ูููุฌููุนุงุช ููุชุฃูุฏ ูู ุชุญุฏูุซูุง
            populateGroupSelects(groups);
        }

        function hideStudentForm() {
            document.getElementById('studentFormSection').classList.add('hidden');
        }

        async function fetchStudents() {
            studentsTableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">... ุฌุงุฑู ุชุญููู ุงูุทูุงุจ ...</td></tr>';

            const filterName = studentFilterName.value.trim();
            const filterGroup = studentFilterGroup.value;
            const filterPhone = studentFilterPhone.value.trim();

            let query = `?select=id,student_name,group_id,phone_student,phone_parent,student_code,${TABLE_GROUPS}(class_name,group_name)&order=student_name.asc`;

            if (filterName) query += `&student_name=ilike.*${filterName}*`;
            if (filterGroup && filterGroup !== 'all') query += `&group_id=eq.${filterGroup}`;
            if (filterPhone) query += `&or=(phone_student.ilike.*${filterPhone}*,phone_parent.ilike.*${filterPhone}*)`;

            try {
                students = await supabaseFetch('GET', TABLE_STUDENTS, query);
                displayStudents(students);
            } catch (error) {
                console.error('Error fetching students:', error);
                studentsTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-red-500 font-bold">ุฎุทุฃ ูู ุฌูุจ ุงูุทูุงุจ: ${error.message}</td></tr>`;
            }
        }

        function displayStudents(currentStudents) {
            studentsTableBody.innerHTML = '';
            studentsCountSpan.textContent = currentStudents.length;
            if (currentStudents.length === 0) {
                studentsTableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุทูุงุจ ูุณุฌููู ูุทุงุจูุฉ ูุดุฑูุท ุงูุจุญุซ.</td></tr>';
                return;
            }

            // ุฅุนุงุฏุฉ ุจูุงุก ูุงุฆูุฉ IDs ุงููุฎุชุงุฑุฉ
            const currentSelected = new Set(Array.from(studentsTableBody.querySelectorAll('input[type="checkbox"]:checked')).map(cb => parseInt(cb.value)));
            selectedStudentIds = new Set();
            currentSelected.forEach(id => {
                if (currentStudents.some(s => s.id === id)) {
                    selectedStudentIds.add(id);
                }
            });

            currentStudents.forEach((student) => {
                const groupInfo = student[TABLE_GROUPS] || {
                    class_name: 'ุบูุฑ ูุญุฏุฏ',
                    group_name: 'ุบูุฑ ูุญุฏุฏ'
                };
                const groupDisplay = `${groupInfo.group_name} (${groupInfo.class_name})`;
                const isChecked = selectedStudentIds.has(student.id) ? 'checked' : '';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';
                row.innerHTML = `
                    <td class="px-4 py-2 text-sm text-gray-500">
                        <input type="checkbox" value="${student.id}" class="student-checkbox rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" ${isChecked}>
                    </td>
                    <td class="px-4 py-2 text-sm font-bold text-red-600">${student.id}</td>
                    <td class="px-4 py-2 font-medium text-gray-900">${student.student_name}</td>
                    <td class="px-4 py-2 text-sm text-indigo-600">${groupDisplay}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${groupInfo.class_name}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${student.phone_student || 'ูุง ููุฌุฏ'}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${student.phone_parent || 'ูุง ููุฌุฏ'}</td>
                    <td class="px-4 py-2 text-center whitespace-nowrap space-x-2 space-x-reverse">
                        <button onclick="viewStudentRecords(${student.id}, '${student.student_name}')" class="text-blue-600 hover:text-blue-900 font-bold py-1 px-2 rounded-md transition text-sm">ุณุฌู ุงูุฃุฏุงุก</button>
                        <button onclick="editStudent(${student.id})" class="text-indigo-600 hover:text-indigo-900 font-bold py-1 px-2 rounded-md transition text-sm">ุชุนุฏูู</button>
                    </td>
                `;
                studentsTableBody.appendChild(row);
            });

            // ุชุญุฏูุซ ุญุงูุฉ ุฒุฑ ุชุญุฏูุฏ ุงููู
            const allChecked = currentStudents.length > 0 && Array.from(studentsTableBody.querySelectorAll('.student-checkbox')).every(cb => cb.checked);
            selectAllStudents.checked = allChecked;
        }

        async function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                showStudentForm(student);
            }
        }

        newStudentForm.addEventListener('submit', async(e) => {
            e.preventDefault();
            const studentId = document.getElementById('studentIdToEdit').value;
            const studentName = document.getElementById('studentName').value.trim();
            const groupID = document.getElementById('studentGroup').value;
            const studentPhone = document.getElementById('studentPhone').value.trim() || null;
            const parentPhone = document.getElementById('parentPhone').value.trim() || null;
            const data = {
                student_name: studentName,
                group_id: parseInt(groupID),
                phone_student: studentPhone,
                phone_parent: parentPhone,
            };

            // ุฅูุดุงุก ููุฏ ูุคูุช ููุทุฑููุฉ ูุฅุฑุถุงุก ููุฏ NOT NULL (ุณูุชู ุงุณุชุจุฏุงูู ูุงุญูุงู ุจุงูู id)
            // ูุฐุง ูุญุงูุธ ุนูู ุงูุชูุงูู ูู ูุงู ุงูุนููุฏ ููุฑูุถุงู ูู NOT NULL ุฃู UNIQUE
            const studentCode = studentId ? undefined : Math.random().toString(36).substring(2, 8).toUpperCase();
            if (!studentId) {
                data.student_code = studentCode;
            }

            const isEdit = !!studentId;
            const method = isEdit ? 'PATCH' : 'POST';
            const query = isEdit ? `?id=eq.${studentId}` : '';
            const action = isEdit ? 'ุชุนุฏูู' : 'ุฅุถุงูุฉ';

            try {
                const response = await supabaseFetch(method, TABLE_STUDENTS, query, data);

                // ุนูุฏ ุงูุฅุถุงูุฉ (POST) ูุญุตู ุนูู ุงูู id ุงููุนุงุฏ ูู Supabase ููุญุฏูุซ student_code ููุทุงุจูู
                if (!studentId && Array.isArray(response) && response[0] && response[0].id) {
                    const newId = response[0].id;
                    try {
                        await supabaseFetch('PATCH', TABLE_STUDENTS, `?id=eq.${newId}`, {
                            student_code: newId
                        });
                    } catch (patchErr) {
                        console.error('Failed to set student_code to id:', patchErr);
                        // ูุง ูููู ุงูุชุฏููุ ููุจูุบ ุงููุณุชุฎุฏู ููู ุนูููุฉ ุงูุฅุถุงูุฉ ูุฌุญุช
                        alert(`ุชู ุฅุถุงูุฉ ุงูุทุงูุจ ูููู ูุดู ุชุนููู ุงูููุฏ (student_code). ุงูุฑุฌุงุก ุงูุชุญูู ูุฏููุงู. Error: ${patchErr.message}`);
                        newStudentForm.reset();
                        hideStudentForm();
                        fetchStudents();
                        return;
                    }
                }

                alert(`ุชู ${action} ุงูุทุงูุจ ุจูุฌุงุญ.`);
                newStudentForm.reset();
                hideStudentForm();
                fetchStudents();
            } catch (error) {
                alert(`ูุดู ${action} ุงูุทุงูุจ: ${error.message}`);
                console.error(`Error ${action} student:`, error);
            }
        });

        // ุฑุจุท ุฃุญุฏุงุซ ุชุตููุฉ ุงูุทูุงุจ
        document.getElementById('applyStudentFilterBtn').addEventListener('click', fetchStudents);
        studentFilterName.addEventListener('input', fetchStudents);
        studentFilterPhone.addEventListener('input', fetchStudents);
        studentFilterGroup.addEventListener('change', fetchStudents);

        // ููุทู ุชุญุฏูุฏ ุงูุทูุงุจ ูุทุจุงุนุฉ ุงููุฑูุช
        studentsTableBody.addEventListener('change', (e) => {
            if (e.target.classList.contains('student-checkbox')) {
                const studentId = parseInt(e.target.value);
                if (e.target.checked) {
                    selectedStudentIds.add(studentId);
                } else {
                    selectedStudentIds.delete(studentId);
                }
            }
        });

        selectAllStudents.addEventListener('change', (e) => {
            const checkboxes = studentsTableBody.querySelectorAll('.student-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = e.target.checked;
                const studentId = parseInt(cb.value);
                if (e.target.checked) {
                    selectedStudentIds.add(studentId);
                } else {
                    selectedStudentIds.delete(studentId);
                }
            });
        });

        exportCardsBtn.addEventListener('click', () => {
            if (selectedStudentIds.size === 0) {
                alert('ุงูุฑุฌุงุก ุชุญุฏูุฏ ุทุงูุจ ูุงุญุฏ ุนูู ุงูุฃูู ูุทุจุงุนุฉ ุงููุฑูุช.');
                return;
            }
            printStudentCards();
        });

        function printStudentCards() {
            const cardsContainer = document.getElementById('cardsToPrint');
            cardsContainer.innerHTML = '';

            const studentsToPrint = students.filter(s => selectedStudentIds.has(s.id));

            studentsToPrint.forEach(student => {
                const groupInfo = groups.find(g => g.id === student.group_id);
                const groupName = groupInfo ? groupInfo.group_name : 'ุบูุฑ ูุญุฏุฏุฉ';
                const card = document.createElement('div');
                card.className = 'student-card';
                card.innerHTML = `
                    <div style="font-size: 14pt; font-weight: bold; margin-bottom: 5px;">ูุงุฑุช ุงูุทุงูุจ - ุงูุฃุณุชุงุฐ ุงูุฎูููุงุฆู</div>
                    <hr style="border-top: 1px solid #ddd; margin: 5px 0;">
                    <p style="font-size: 16pt; margin: 5px 0;">**ุงูุงุณู:** ${student.student_name}</p>
                    <p style="font-size: 12pt; margin: 3px 0;">**ุงููุฌููุนุฉ:** ${groupName}</p>
                    <p style="font-size: 14pt; font-weight: bold; color: #cc0000; margin: 8px 0;">**ุงูููุฏ:** ${student.id}</p>
                    <p style="font-size: 10pt; margin: 0;">ูุณุชุฎุฏู ูุฐุง ุงูููุฏ ููุชุณุฌูู ูู ุงูุงูุชุญุงูุงุช</p>
                `;
                cardsContainer.appendChild(card);
            });

            // ุฅุธูุงุฑ ูุณู ุงูุทุจุงุนุฉ ูุงุณุชุฏุนุงุก ูุธููุฉ ุงูุทุจุงุนุฉ
            cardsContainer.classList.remove('hidden');
            window.print();

            // ุฅุฎูุงุก ูุณู ุงูุทุจุงุนุฉ ุจุนุฏ ุงูุฅูุชูุงุก
            setTimeout(() => {
                cardsContainer.classList.add('hidden');
            }, 500);
        }


        // ---- C. ูุธุงุฆู ุณุฌูุงุช ุงูุญุถูุฑ ูุงูุฃุฏุงุก (Records) ----

        function showRecordModal(studentId, studentName) {
            const recordModal = document.getElementById('recordModal');
            document.getElementById('recordModalStudentName').textContent = studentName;
            document.getElementById('recordStudentId').value = studentId;
            document.getElementById('recordForm').reset();

            // ุชุนููู ุงูุชุงุฑูุฎ ุงูุญุงูู ูุงูุชุฑุงุถู
            document.getElementById('recordDate').valueAsDate = new Date();
            // ุชุนููู ุงูุดูุฑ ุงูุญุงูู ูุงูุชุฑุงุถู
            document.getElementById('recordMonth').value = monthNames[new Date().getMonth()];

            recordModal.classList.remove('hidden');
        }

        document.getElementById('recordForm').addEventListener('submit', async(e) => {
            e.preventDefault();

            const studentId = document.getElementById('recordStudentId').value;
            const lessonDate = document.getElementById('recordDate').value; // yyyy-mm-dd
            const lessonMonth = document.getElementById('recordMonth').value;
            const lessonNumber = document.getElementById('recordLessonNumber').value;
            const attendance = document.getElementById('recordAttendance').value;
            const homework = document.getElementById('recordHomework').value === 'true';

            // ๐ ูุฑุงุกุฉ ุงูุญููู ุงูุฌุฏูุฏุฉ
            const recitationDegree = document.getElementById('recordRecitationDegree').value || null;
            const comprehensiveExam = document.getElementById('recordComprehensiveExam').value || null;
            // /๐ ููุงูุฉ ุงููุฑุงุกุฉ

            const examDegree = document.getElementById('recordExamDegree').value || null;

            const data = {
                student_id: parseInt(studentId),
                lesson_date: lessonDate,
                lesson_month: lessonMonth,
                lesson_number: parseInt(lessonNumber),
                attendance: attendance,
                homework_done: homework,

                // ๐จ ุฅุถุงูุฉ ุงูุฃุนูุฏุฉ ุงูุฌุฏูุฏุฉ ููุง
                recitation_degree: recitationDegree ? parseInt(recitationDegree) : null,
                comprehensive_exam_degree: comprehensiveExam ? parseInt(comprehensiveExam) : null,
                // /๐จ ููุงูุฉ ุฅุถุงูุฉ ุงูุฃุนูุฏุฉ

                exam_degree: examDegree ? parseInt(examDegree) : null
            };

            try {
                await supabaseFetch('POST', TABLE_RECORDS, '', data);
                alert('ุชู ุญูุธ ุณุฌู ุงูุฃุฏุงุก ุจูุฌุงุญ! โ');
                document.getElementById('recordModal').classList.add('hidden');
                // ๐ ุชุญุฏูุซ ูุนุฑุถ ุงูุณุฌูุงุช ููุฑุงู ูุน ุงูุญูุงุธ ุนูู ุงูุตูุญุฉ ุงูุญุงููุฉ
                viewStudentRecords(parseInt(studentId), document.getElementById('recordModalStudentName').textContent);
            } catch (error) {
                alert(`ูุดู ุญูุธ ุณุฌู ุงูุฃุฏุงุก: ${error.message}`);
                console.error('Error saving record:', error);
            }
        });


        async function viewStudentRecords(studentId, studentName) {
            // ๐ ุชุฎุฒูู ุจูุงูุงุช ุงูุทุงูุจ ุงูุญุงูู
            currentViewingStudent = {
                id: studentId,
                name: studentName
            };

            // ุงูุชุฃูุฏ ูู ุฃู tab-content ุงูุฑุฆูุณู (students-content) ูุนุฑูุถ
            document.getElementById('students-content').classList.remove('hidden');

            // ุฅุฎูุงุก ุฌููุน ุงูุฃูุณุงู ุงูุฃุฎุฑู ุฏุงุฎู students-content
            document.getElementById('groupFormSection').classList.add('hidden');
            document.getElementById('studentFormSection').classList.add('hidden');

            // ุฅุธูุงุฑ ูุณู ุงูุณุฌูุงุช
            document.getElementById('studentRecordsView').classList.remove('hidden');

            document.getElementById('recordsStudentName').textContent = studentName;

            const recordsTableBody = document.getElementById('recordsTableBody');
            recordsTableBody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">... ุฌุงุฑู ุชุญููู ุงูุณุฌูุงุช ...</td></tr>';

            try {
                // ๐จ ุงูุชุตุญูุญ: ูุฌุจ ุชุญุฏูุฏ ุฌููุน ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ ููุง
                const records = await supabaseFetch('GET', TABLE_RECORDS, `?student_id=eq.${studentId}&select=lesson_date,lesson_month,lesson_number,attendance,homework_done,recitation_degree,exam_degree,comprehensive_exam_degree&order=lesson_date.desc`);

                recordsTableBody.innerHTML = '';
                if (records.length === 0) {
                    recordsTableBody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุณุฌูุงุช ููุฐุง ุงูุทุงูุจ.</td></tr>';
                    return;
                }

                records.forEach(record => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition duration-150';
                    row.innerHTML = `
                        <td class="px-4 py-2 text-sm text-gray-700">${record.lesson_date}</td>
                        <td class="px-4 py-2 text-sm text-gray-700">${record.lesson_month}</td>
                        <td class="px-4 py-2 text-sm text-gray-700">${record.lesson_number}</td>
                        <td class="px-4 py-2 text-sm ${record.attendance === 'ุญุถุฑ' ? 'text-green-600' : 'text-red-600'} font-bold">${record.attendance}</td>
                        <td class="px-4 py-2 text-sm ${record.homework_done ? 'text-green-600' : 'text-red-600'} font-bold">${record.homework_done ? 'ุชู โ' : 'ูู ูุชู โ'}</td>
                        <td class="px-4 py-2 text-sm text-gray-700">${record.recitation_degree || 'โ'}</td>
                        <td class="px-4 py-2 text-sm text-gray-700">${record.exam_degree || 'โ'}</td>
                        <td class="px-4 py-2 text-sm text-gray-700">${record.comprehensive_exam_degree || 'โ'}</td>
                        <td class="px-4 py-2 text-center whitespace-nowrap space-x-2 space-x-reverse">
                            <button onclick="deleteRecord('${record.lesson_date}', ${currentViewingStudent.id})" class="text-red-600 hover:text-red-900 font-bold py-1 px-2 rounded-md transition text-sm">๐๏ธ ุญุฐู</button>
                        </td>
                    `;
                    recordsTableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error fetching records:', error);
                recordsTableBody.innerHTML = `<tr><td colspan="9" class="px-6 py-4 text-center text-red-500 font-bold">ุฎุทุฃ ูู ุฌูุจ ุงูุณุฌูุงุช: ${error.message}</td></tr>`;
            }
        }

        // ๐ ุฏุงูุฉ ุญุฐู ุงูุณุฌู
        async function deleteRecord(lessonDate, studentId) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุณุฌูุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐู ุงูุนูููุฉ.')) {
                return;
            }

            try {
                await supabaseFetch('DELETE', TABLE_RECORDS, `?student_id=eq.${studentId}&lesson_date=eq.${lessonDate}`);
                alert('ุชู ุญุฐู ุงูุณุฌู ุจูุฌุงุญ! โ');
                // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุณุฌูุงุช
                viewStudentRecords(studentId, currentViewingStudent.name);
            } catch (error) {
                alert(`ูุดู ุญุฐู ุงูุณุฌู: ${error.message}`);
                console.error('Error deleting record:', error);
            }
        }

        // ๐ ุฏุงูุฉ ุฌุฏูุฏุฉ ููุชุญ ูููุฐุฌ ุฅุถุงูุฉ ุณุฌู ูู ุตูุญุฉ ุงูุณุฌูุงุช
        function openAddRecordForm() {
            const recordModal = document.getElementById('recordModal');
            document.getElementById('recordModalStudentName').textContent = currentViewingStudent.name;
            document.getElementById('recordStudentId').value = currentViewingStudent.id;
            document.getElementById('recordForm').reset();

            // ุชุนููู ุงูุชุงุฑูุฎ ุงูุญุงูู ูุงูุชุฑุงุถู
            document.getElementById('recordDate').valueAsDate = new Date();
            // ุชุนููู ุงูุดูุฑ ุงูุญุงูู ูุงูุชุฑุงุถู
            document.getElementById('recordMonth').value = monthNames[new Date().getMonth()];

            recordModal.classList.remove('hidden');
        }

        // ุฑุจุท ุฒุฑ "ุณุฌู ุงูุฃุฏุงุก" ูู ูุงุฆูุฉ ุงูุทูุงุจ ููุธููุฉ ุนุฑุถ ุงูุณุฌูุงุช
        // ุชู ุฅุฒุงูุฉ ูุฐุง ุงูู event listener ูุฃู ุงูุฒุฑ ุงูุขู ูุญุชูู ุนูู onclick ูุจุงุดุฑ
        // ูุจุงูุชุงูู ูุง ูุญุชุงุฌ event listener ุฅุถุงูู


        // ุงูุชุญููู ุงููุจุฏุฆู
        document.addEventListener('DOMContentLoaded', () => {
            window.showTab('students'); // ุงูุจุฏุก ุจุนุฑุถ ุฅุฏุงุฑุฉ ุงูุทูุงุจ ููู ูุชู ุชุญููู ุงููุฌููุนุงุช ุฃููุงู
        });
    </script>
</body>

</html>
