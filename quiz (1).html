<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr Ayman Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        .card label {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            display: block;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #FFFFFF;
            color: #1F2937;
            margin-bottom: 0.5rem;
            border: 2px solid #E5E7EB;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        
        .card label:hover {
            background-color: #F9FAFB;
            border-color: #6366F1;
        }
        
        .card input[type="radio"] {
            display: none;
        }
        
        .selected-answer {
            background-color: #4338CA !important;
            border-color: #A5B4FC !important;
            color: white !important;
        }
        
        .correct-answer {
            background-color: #10B981 !important;
            color: white !important;
            border-color: #34D399 !important;
        }
        
        .incorrect-answer {
            background-color: #EF4444 !important;
            color: white !important;
            border-color: #F87171 !important;
        }
        
        .explanation {
            background-color: #FFFBEB;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #F59E0B;
            color: #92400E;
            animation: fadeIn 0.5s;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col items-center p-4 sm:p-6">

    <header class="w-full max-w-4xl text-center bg-gradient-to-r from-blue-400 to-indigo-600 p-6 rounded-3xl shadow-xl mb-8 fade-in text-white">
        <h1 class="text-4xl font-extrabold">Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø£Ø±ÙŠØ¨</h1>
        <p class="text-xl mt-2 opacity-95">Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚ ÙŠØ§ ØµØ¯ÙŠÙ‚ÙŠ</p>
    </header>

    <main id="classSelection" class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl text-center fade-in border border-gray-200">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</h2>
        <select id="classSelect" class="w-full bg-gray-100 text-gray-800 p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-indigo-500 transition">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>
            <option value="s1">Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ</option>
            <option value="s2">ØªØ§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ</option>
            <option value="s3">ØªØ§Ù„ØªØ© Ø«Ø§Ù†ÙˆÙŠ</option>
        </select>
        <button id="startBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg mt-6 transition transform hover:scale-[1.02] shadow-md">
            Ø§Ø¨Ù€Ø¯Ø£ Ø§Ù„Ø§Ø®Ù€ØªÙ€Ø¨Ù€Ø§Ø±
        </button>
    </main>

    <section id="quizSection" class="hidden w-full max-w-4xl mt-8 fade-in">
        <div class="bg-white p-6 rounded-2xl shadow-xl mb-6 border border-gray-200">
            <input id="studentName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" class="w-full p-3 bg-gray-100 text-gray-900 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-purple-500 transition mb-4" required>
            <input id="studentPhone" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… ØªÙ„ÙŠÙÙˆÙ†Ùƒ Ù‡Ù†Ø§" class="w-full p-3 bg-gray-100 text-gray-900 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-purple-500 transition" required>
        </div>
        <form id="quizForm" class="space-y-6"></form>
        <div id="result" class="mt-6 text-2xl font-bold text-center p-4 bg-green-50 text-green-800 rounded-2xl shadow-lg hidden border-l-8 border-green-400"></div>
        <button id="submitBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg mt-6 transition transform hover:scale-[1.02] shadow-md">
            Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
        </button>
    </section>

    <footer style="
    position: relative; z-index: 9999; text-align: center; padding: 40px 0; margin-top: 50px; background: transparent;
">
        <div style="
        background: rgba(255, 255, 255, 0.95); color: #111; max-width: 400px; margin: 0 auto; border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 1px solid #ddd; padding: 25px;
    ">
            <p style="font-weight: 600; margin-bottom: 15px; font-size: 16px;">
                ØµÙÙ…Ù‘Ù… Ø¨ÙˆØ§Ø³Ø·Ø©
                <span style="color: #2563eb; font-weight: 700;">Abdelrahman Tarek</span>
            </p>
            <a href="https://wa.me/201094724932" target="_blank" style="
                display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(to right, #2563eb, #3b82f6);
                color: #fff; font-weight: 600; font-size: 14px; padding: 10px 18px; border-radius: 9999px;
                text-decoration: none; box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: all 0.3s;
            " onmouseover="this.style.background='linear-gradient(to right,#3b82f6,#60a5fa)'" onmouseout="this.style.background='linear-gradient(to right,#2563eb,#3b82f6)'">
                <i class="fa-solid fa-envelope"></i> ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§
            </a>
        </div>
    </footer>

    <script>
        // *************************************************************
        // ** âš ï¸ ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ… Placeholder Ø¨Ù…ÙØ§ØªÙŠØ­Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© âš ï¸ **
        // *************************************************************
        const SUPABASE_URL = "https://arbbxmnjviryxkmhwdgk.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyYmJ4bW5qdmlyeXhrbWh3ZGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2OTU1NDEsImV4cCI6MjA3ODI3MTU0MX0.G-MsJtbQ1LlPZO-Vob6nKzdClHmOYu6RFOKi62FKKNk";
        const TABLE_RESULTS = "quiz_results"; // Ø¬Ø¯ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        const TABLE_QUIZZES = "quizzes"; // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        const TABLE_QUESTIONS = "questions"; // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        // *************************************************************

        let questions = [];
        let correctAnswers = {};
        let explanations = {};
        let selectedClass = "";

        const classNames = {
            s1: "Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ",
            s2: "ØªØ§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ",
            s3: "ØªØ§Ù„ØªØ© Ø«Ø§Ù†ÙˆÙŠ"
        };

        // ğŸš¨ Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Supabase
        async function fetchQuestionsFromSupabase(classKey) {
            const className = classNames[classKey];

            // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø­Ø¯Ø« Ø§Ù…ØªØ­Ø§Ù† Ù…ÙÙØ¹Ù‘ÙÙ„ Ù„Ù„ØµÙ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            const quizUrl = `${SUPABASE_URL}/rest/v1/${TABLE_QUIZZES}?select=id&class_name=eq.${className}&is_active=eq.true&order=created_at.desc&limit=1`;

            let response = await fetch(quizUrl, {
                method: 'GET',
                headers: {
                    'apikey': SUPABASE_ANON_KEY
                }
            });

            if (!response.ok) throw new Error("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.");
            const quizzes = await response.json();

            if (quizzes.length === 0) {
                throw new Error(`Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ù…ØªØ­Ø§Ù† Ù…ÙÙØ¹Ù‘ÙÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù„ØµÙ "${className}".`);
            }

            const quizId = quizzes[0].id;

            // 2. Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
            const questionsUrl = `${SUPABASE_URL}/rest/v1/${TABLE_QUESTIONS}?select=id,question_text,choice_a,choice_b,choice_c,choice_d,correct_answer,explanation&quiz_id=eq.${quizId}`;
            response = await fetch(questionsUrl, {
                method: 'GET',
                headers: {
                    'apikey': SUPABASE_ANON_KEY
                }
            });

            if (!response.ok) throw new Error("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
            const rawQuestions = await response.json();

            // 3. Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªÙ†Ø§Ø³Ø¨ Ø·Ø±ÙŠÙ‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            return rawQuestions.map(q => {
                const correctChoiceLetter = q.correct_answer ? q.correct_answer.toUpperCase() : 'A';
                const correctChoiceText = q[`choice_${correctChoiceLetter.toLowerCase()}`];

                return {
                    id: q.id.toString(),
                    question: q.question_text,
                    choices: [q.choice_a, q.choice_b, q.choice_c, q.choice_d],
                    correct: correctChoiceText,
                    explanation: q.explanation || ''
                };
            });
        }

        document.getElementById("startBtn").addEventListener("click", async() => {
            selectedClass = document.getElementById("classSelect").value;
            if (!selectedClass) {
                alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }

            document.getElementById("startBtn").textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...";
            document.getElementById("startBtn").disabled = true;

            try {
                questions = await fetchQuestionsFromSupabase(selectedClass);

                if (questions.length === 0) {
                    throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù…ÙÙØ¹Ù„.");
                }

                showQuestions();
                document.getElementById("classSelection").classList.add("hidden");
                document.getElementById("quizSection").classList.remove("hidden");
            } catch (error) {
                alert(`Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${error.message}.`);
                document.getElementById("startBtn").textContent = "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±";
                document.getElementById("startBtn").disabled = false;
            }
        });

        function showQuestions() {
            const form = document.getElementById("quizForm");
            form.innerHTML = "";
            questions.forEach((q, index) => {
                correctAnswers[q.id] = q.correct;
                explanations[q.id] = q.explanation;

                let choicesHtml = q.choices.map((c, idx) => `
                <label>
                    <input type="radio" name="${q.id}" value="${c}">
                    <span>${c}</span>
                </label>
            `).join("");

                let html = `
                <div class="card bg-white p-5 rounded-2xl shadow-lg border border-gray-200 fade-in" style="animation-delay: ${index * 100}ms;">
                    <p class="font-bold text-lg mb-4 text-gray-800">${index + 1}. ${q.question}</p>
                    <div class="choices space-y-2">${choicesHtml}</div>
                </div>
            `;
                form.innerHTML += html;
            });

            form.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    const parent = event.target.closest('.choices');
                    parent.querySelectorAll('label').forEach(label => label.classList.remove('selected-answer'));
                    event.target.parentElement.classList.add('selected-answer');
                });
            });
        }

        document.getElementById("submitBtn").addEventListener("click", async(e) => {
            e.preventDefault();
            const name = document.getElementById("studentName").value.trim();
            const phone = document.getElementById("studentPhone").value.trim();
            if (!name || !phone) {
                alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©");
                return;
            }

            document.getElementById("submitBtn").disabled = true;
            document.getElementById("submitBtn").textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ­ÙŠØ­...";

            let score = 0,
                wrong = [],
                total = questions.length;
            questions.forEach(q => {
                const selectedRadio = document.querySelector(`input[name="${q.id}"]:checked`);
                const card = selectedRadio ? selectedRadio.closest(".card") : document.querySelector(`input[name="${q.id}"]`).closest('.card');

                document.querySelectorAll(`input[name="${q.id}"]`).forEach(opt => {
                    const label = opt.parentElement;
                    label.classList.remove('selected-answer');
                    if (opt.value === q.correct) {
                        label.classList.add('correct-answer');
                    }
                });

                if (selectedRadio) {
                    const selectedLabel = selectedRadio.parentElement;
                    if (selectedRadio.value === q.correct) {
                        score++;
                    } else {
                        selectedLabel.classList.add('incorrect-answer');
                        wrong.push(q.id);
                        if (q.explanation) {
                            const exp = document.createElement("div");
                            exp.className = "explanation";
                            exp.innerHTML = `<b>ğŸ’¡ Ø§Ù„Ø´Ø±Ø­:</b> ${q.explanation}`;
                            card.appendChild(exp);
                        }
                    }
                } else {
                    wrong.push(q.id);
                    if (q.explanation) {
                        const exp = document.createElement("div");
                        exp.className = "explanation";
                        exp.innerHTML = `<b>ğŸ’¡ Ø§Ù„Ø´Ø±Ø­:</b> ${q.explanation}`;
                        card.appendChild(exp);
                    }
                }
            });

            const resultDiv = document.getElementById("result");
            resultDiv.innerHTML = `âœ… Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${score} / ${total}`;
            resultDiv.classList.remove('hidden');
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });

            document.getElementById("submitBtn").style.display = 'none';

            try {
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ quiz_results
                const dataToSubmit = {
                    student_name: name,
                    student_phone: phone,
                    class_name: classNames[selectedClass],
                    score: score,
                    total_questions: total,
                    wrong_questions_ids: wrong.join(',')
                };

                const response = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_RESULTS}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "apikey": SUPABASE_ANON_KEY,
                        "Prefer": "return=minimal"
                    },
                    body: JSON.stringify(dataToSubmit)
                });

                if (!response.ok) {
                    console.error('Failed to save result to Supabase:', response.status, response.statusText);
                } else {
                    console.log('Result successfully saved to Supabase!');
                }
            } catch (error) {
                console.error('An error occurred during API fetch:', error);
            }
        });
    </script>
</body>

</html>
