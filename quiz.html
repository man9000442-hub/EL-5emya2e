<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø®ÙŠÙ…ÙŠØ§Ø¦ÙŠ | Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .selected-answer { background-color: #eef2ff !important; border-color: #4f46e5 !important; }
        .radio-label { transition: all 0.2s; cursor: pointer; display: flex; align-items: center; padding: 1rem; border-radius: 1rem; border: 2px solid #f1f5f9; margin-bottom: 0.75rem; background: white; }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="max-w-4xl mx-auto text-center mb-10 fade-in">
        <div class="bg-indigo-600 text-white py-10 px-6 rounded-[2.5rem] shadow-2xl shadow-indigo-200">
            <h1 class="text-4xl md:text-5xl font-black mb-3">Ù…ÙÙ†ØµØ© Ø§Ù„Ø®ÙŠÙ…ÙŠØ§Ø¦ÙŠ</h1>
            <p class="text-indigo-100 text-lg">Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø°ÙƒÙŠ - Ù„Ø§ ØªØ±Ø§Ø¬Ø¹ ÙˆÙ„Ø§ Ø§Ø³ØªØ³Ù„Ø§Ù…</p>
        </div>
    </header>

    <main id="loginSection" class="max-w-md mx-auto bg-white p-8 rounded-3xl shadow-xl border border-slate-100 fade-in">
        <h2 class="text-2xl font-bold text-slate-800 text-center mb-8">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
        <div class="space-y-5">
            <div>
                <label class="block text-slate-600 font-bold mb-2 mr-2">ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                <input id="inputCode" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-indigo-500 outline-none text-center font-bold text-lg">
            </div>
            <div>
                <label class="block text-slate-600 font-bold mb-2 mr-2">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input id="inputPhone" type="tel" placeholder="Ø±Ù‚Ù… Ù…ÙˆØ¨Ø§ÙŠÙ„Ùƒ" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-indigo-500 outline-none text-center font-bold text-lg">
            </div>
            <button id="loginBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-2xl shadow-lg transition-all transform active:scale-95 flex items-center justify-center gap-2">
                <span>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†</span>
                <i class="fa-solid fa-bolt"></i>
            </button>
            <p id="loginError" class="hidden text-red-600 bg-red-50 p-4 rounded-xl border border-red-100 text-center font-bold text-sm"></p>
        </div>
    </main>

    <section id="quizSection" class="hidden max-w-4xl mx-auto fade-in">
        <div class="bg-white p-6 rounded-2xl shadow-sm border-r-8 border-indigo-600 mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <p class="text-slate-400 text-sm font-bold">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</p>
                <p id="displayStudentName" class="text-2xl font-black text-slate-800"></p>
            </div>
            <div id="displayClassName" class="bg-indigo-50 text-indigo-700 px-6 py-2 rounded-full font-bold"></div>
        </div>

        <div id="quizContainer">
            <form id="quizForm" class="space-y-6"></form>
            <button id="submitBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-black py-5 rounded-3xl mt-12 shadow-xl text-xl flex items-center justify-center gap-3">
                <i class="fa-solid fa-check-double"></i>
                <span>Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</span>
            </button>
        </div>

        <div id="finalResultContainer" class="hidden bg-white p-12 rounded-[3rem] shadow-2xl border-4 border-indigo-50 text-center">
            <span class="text-7xl">ğŸŒŸ</span>
            <h2 class="text-3xl font-black text-slate-800 mt-6">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù†ØªÙŠØ¬ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!</h2>
            <div id="finalScore" class="text-7xl font-black text-indigo-600 my-8 italic"></div>
            <div class="space-y-3 bg-slate-50 p-6 rounded-2xl max-w-sm mx-auto text-right">
                <p class="font-bold text-slate-600">ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: <span id="resName" class="text-slate-900"></span></p>
                <p class="font-bold text-slate-600">ğŸ”‘ Ø§Ù„ÙƒÙˆØ¯: <span id="resCode" class="text-slate-900"></span></p>
            </div>
            <button onclick="window.location.reload()" class="mt-8 text-indigo-600 font-bold hover:underline">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
    </section>

    <script>
        const SUPABASE_URL = "https://arbbxmnjviryxkmhwdgk.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyYmJ4bW5qdmlyeXhrbWh3ZGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2OTU1NDEsImV4cCI6MjA3ODI3MTU0MX0.G-MsJtbQ1LlPZO-Vob6nKzdClHmOYu6RFOKi62FKKNk";
        
        const DB = {
            RESULTS: "alchemiya_results",
            QUIZZES: "alchemiya_quizzes",
            QUESTIONS: "alchemiya_questions",
            STUDENTS: "alchemiya_students",
            GROUPS: "alchemiya_groups"
        };

        let questions = [];
        let currentQuizId = null;
        let student = { name: "", code: "", phone: "", className: "" };

        // === Ø¯Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠØ© ===
        async function handleLogin() {
            const code = document.getElementById("inputCode").value.trim();
            const phone = document.getElementById("inputPhone").value.trim();
            const btn = document.getElementById("loginBtn");
            const err = document.getElementById("loginError");

            if (!code || !phone) { alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹"); return; }

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø³Ø¬Ù„Ø§Øª...';
            err.classList.add("hidden");

            try {
                // 1. ÙØ­Øµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
                const resS = await fetch(`${SUPABASE_URL}/rest/v1/${DB.STUDENTS}?student_code=eq.${code}&select=student_name,group_id`, { headers: { 'apikey': SUPABASE_ANON_KEY } });
                const students = await resS.json();
                if (!students.length) throw new Error("Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± Ù…Ø³Ø¬Ù„.");

                student.name = students[0].student_name;
                student.code = code;
                student.phone = phone;

                // 2. Ø¬Ù„Ø¨ Ø§Ù„ØµÙ ÙˆØ§Ù„Ø§Ù…ØªØ­Ø§Ù†
                const resG = await fetch(`${SUPABASE_URL}/rest/v1/${DB.GROUPS}?id=eq.${students[0].group_id}&select=class_name`, { headers: { 'apikey': SUPABASE_ANON_KEY } });
                const groups = await resG.json();
                student.className = groups[0].class_name;

                const resQ = await fetch(`${SUPABASE_URL}/rest/v1/${DB.QUIZZES}?class_name=eq.${encodeURIComponent(student.className)}&is_active=eq.true&select=id&limit=1`, { headers: { 'apikey': SUPABASE_ANON_KEY } });
                const quizzes = await resQ.json();
                if (!quizzes.length) throw new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ù…ØªØ­Ø§Ù† Ù…ØªØ§Ø­ Ù„ØµÙÙƒ Ø­Ø§Ù„ÙŠØ§Ù‹.");
                currentQuizId = quizzes[0].id;

                // 3. Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± (Ø§Ù„ÙØ­Øµ Ø§Ù„Ù‚Ø§Ø·Ø¹ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬)
                // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„ÙƒÙˆØ¯ + Ø±Ù‚Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ…Ø§Ù…Ø§Ù‹
                const resCheck = await fetch(`${SUPABASE_URL}/rest/v1/${DB.RESULTS}?student_code=eq.${code}&quiz_id=eq.${currentQuizId}&select=id`, { 
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Cache-Control': 'no-cache' } 
                });
                const existing = await resCheck.json();

                if (existing.length > 0) {
                    throw new Error(`Ø¹Ø°Ø±Ø§Ù‹ ÙŠØ§ ${student.name}ØŒ Ù„Ù‚Ø¯ Ø£Ø¯ÙŠØª Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙˆÙ„Ø§ ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªÙƒØ±Ø§Ø±.`);
                }

                // 4. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø¹Ø±Ø¶
                await loadQuestions(currentQuizId);
                displayExam();

            } catch (e) {
                err.textContent = e.message;
                err.classList.remove("hidden");
                btn.disabled = false;
                btn.innerHTML = '<span>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†</span> <i class="fa-solid fa-bolt"></i>';
            }
        }

        async function loadQuestions(id) {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/${DB.QUESTIONS}?quiz_id=eq.${id}&select=id,question_text,choice_a,choice_b,choice_c,choice_d,correct_answer`, { headers: { 'apikey': SUPABASE_ANON_KEY } });
            const data = await res.json();
            questions = data.map(q => ({
                id: q.id,
                text: q.question_text,
                choices: [q.choice_a, q.choice_b, q.choice_c, q.choice_d],
                correct: q[`choice_${q.correct_answer.toLowerCase()}`]
            }));
        }

        function displayExam() {
            document.getElementById("displayStudentName").textContent = student.name;
            document.getElementById("displayClassName").textContent = "Ø§Ù„ØµÙ: " + student.className;
            
            const form = document.getElementById("quizForm");
            form.innerHTML = questions.map((q, i) => `
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 fade-in" style="animation-delay: ${i*0.1}s">
                    <p class="font-bold text-xl mb-6 text-slate-800"><span class="text-indigo-600">Ø³${i+1}:</span> ${q.text}</p>
                    <div class="choices-area">
                        ${q.choices.map(c => `
                            <label class="radio-label">
                                <input type="radio" name="q${q.id}" value="${c}" class="hidden" required>
                                <span class="font-bold text-slate-700">${c}</span>
                            </label>
                        `).join("")}
                    </div>
                </div>
            `).join("");

            // ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            form.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const parent = e.target.closest('.choices-area');
                    parent.querySelectorAll('label').forEach(l => l.classList.remove('selected-answer'));
                    e.target.closest('label').classList.add('selected-answer');
                });
            });

            document.getElementById("loginSection").classList.add("hidden");
            document.getElementById("quizSection").classList.remove("hidden");
        }

        document.getElementById("loginBtn").addEventListener("click", handleLogin);

        document.getElementById("submitBtn").addEventListener("click", async () => {
            const inputs = document.querySelectorAll('input[type="radio"]:checked');
            if (inputs.length < questions.length) {
                alert("Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ….");
                return;
            }

            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.")) return;

            const btn = document.getElementById("submitBtn");
            btn.disabled = true;
            btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©...";

            let score = 0;
            let wrongIds = [];
            questions.forEach(q => {
                const picked = document.querySelector(`input[name="q${q.id}"]:checked`);
                if (picked && picked.value === q.correct) score++;
                else wrongIds.push(q.id);
            });

            // Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/${DB.RESULTS}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "apikey": SUPABASE_ANON_KEY },
                    body: JSON.stringify({
                        student_name: student.name,
                        student_code: student.code, // Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù…Ù†Ø¹
                        student_phone: student.phone,
                        class_name: student.className,
                        quiz_id: currentQuizId,
                        score: score,
                        total_questions: questions.length,
                        wrong_questions_ids: wrongIds.join(',')
                    })
                });

                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
                document.getElementById("quizContainer").classList.add("hidden");
                document.getElementById("finalScore").textContent = `${score} / ${questions.length}`;
                document.getElementById("resName").textContent = student.name;
                document.getElementById("resCode").textContent = student.code;
                document.getElementById("finalResultContainer").classList.remove("hidden");
                window.scrollTo(0, 0);

            } catch (e) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ØŒ ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø­Ù„ÙŠØ§Ù‹.");
            }
        });
    </script>
</body>
</html>
